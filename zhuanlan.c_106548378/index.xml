<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:media="http://search.yahoo.com/mrss/">
<channel>
<title>babyquant谈量化金融</title>
<link>https://henix.github.io/feeds/zhuanlan.c_106548378/</link>
<description></description>
<language>zh-cn</language>
<lastBuildDate>Thu, 26 Jul 2018 00:18:54 +0800</lastBuildDate>
<item>
<title>1.5 量化技术篇—使用zipline回测</title>
<link>https://henix.github.io/feeds/zhuanlan.c_106548378/2018-07-25-40565731.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/40565731&quot;&gt;原文&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;b&gt;------从零开始学量化------&lt;/b&gt;&lt;br&gt;&lt;b&gt;简书&lt;/b&gt;：&lt;a href=&quot;https://www.jianshu.com/p/2c34aee64649&quot;&gt;量化目录传送门&lt;/a&gt;&lt;br&gt;&lt;b&gt;知乎&lt;/b&gt;：&lt;a href=&quot;https://zhuanlan.zhihu.com/p/38656100&quot;&gt;量化目录传送门&lt;/a&gt; &lt;/p&gt;&lt;hr&gt;&lt;h2&gt;0. 前言&lt;/h2&gt;&lt;p&gt;在1.4中，我们实现了一个简单的量化择时策略，那么该策略到底效果如何呢？我们该使用什么开源框架，使用历史数据回测策略呢？我们又该用那些指标评价一个策略？&lt;/p&gt;&lt;p&gt;本篇的内容就是回答以上的问题的，下面给一个简要的答案：  &lt;/p&gt;&lt;p&gt;&lt;b&gt;回测的开源框架&lt;/b&gt;：&lt;b&gt;zipline&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;策略的评价指标&lt;/b&gt;：&lt;/p&gt;&lt;ul&gt;&lt;li&gt;累计收益&lt;/li&gt;&lt;li&gt;年化收益&lt;/li&gt;&lt;li&gt;最大回撤&lt;/li&gt;&lt;li&gt;夏普比率&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;为什么选择zipline？主要由以下几点原因：&lt;/p&gt;&lt;ul&gt;&lt;li&gt;在quant的框架中star数最多，版本更新和维护比较快。&lt;/li&gt;&lt;li&gt;社区生态比较好，出现问题，google容易找到解决方案。&lt;/li&gt;&lt;li&gt;该框架在国外已经比较成熟，坑少。&lt;/li&gt;&lt;/ul&gt;&lt;h2&gt;1. 策略的回测结果&lt;/h2&gt;&lt;h2&gt;1.1 策略的回测指标&lt;/h2&gt;&lt;p&gt;年化收益率 = 8.34%&lt;br&gt;&lt;br&gt;累计收益率 = 17.37%&lt;br&gt;&lt;br&gt;最大回撤 = -16.14%&lt;br&gt;&lt;br&gt;夏普比率 = 0.62  &lt;/p&gt;&lt;h2&gt;1.2 策略的收益图&lt;/h2&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-9fc26cb0d26a6f7a4e2ff158d7e19ea9_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;480&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-9fc26cb0d26a6f7a4e2ff158d7e19ea9&quot; data-watermark-src=&quot;v2-84d37accd772d5c13a4cbd590c0f3ac1&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h2&gt;1.3 回测的环境&lt;/h2&gt;&lt;p&gt;量化框架：zipline（version = 1.3.0）&lt;/p&gt;&lt;h2&gt;1.4 策略追踪的股票和benchmark&lt;/h2&gt;&lt;p&gt;追踪的股票：个股选择了苹果（AAPL）&lt;br&gt;&lt;br&gt;benchmark：美国标普500（SPX）的指数&lt;br&gt;&lt;br&gt;策略时间： 2015-01-01 ~ 2017-01-01  &lt;/p&gt;&lt;h2&gt;1.5 择时策略描述&lt;/h2&gt;&lt;p&gt;买入： 当cci &amp;gt;= 50&lt;br&gt;&lt;br&gt;卖出：当cci &amp;lt; 50&lt;/p&gt;&lt;h2&gt;2. zipline回测前的准备&lt;/h2&gt;&lt;p&gt;在开始回测之前，zipline首先需要下载数据包（data bundle）。由于在1.2篇——环境安装中已经说明了zipline的安装方式,如果还有问题可以查看&lt;a href=&quot;https://github.com/quantopian/zipline#installation&quot;&gt;zipline github installation&lt;/a&gt;。下面假设大家已经使用anaconda安装好了zipline（我的zipline的版本是1.3.0）。&lt;/p&gt;&lt;p&gt;zipline安装完毕后，可以打开命令行，输入命令查询zipline目前支持的数据包，具体可以参考&lt;a href=&quot;https://blog.csdn.net/qq_39377696/article/details/80414711&quot;&gt;Zipline Data Bundles&lt;/a&gt;，输入的命令如下：&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;# 命令行中输入查询数据包的命令
zipline bundles

# 返回的结果
csvdir &amp;lt;no ingestions&amp;gt;
quandl &amp;lt;no ingestions&amp;gt;
quantopian-quandl &amp;lt;no ingestions&amp;gt;&lt;/code&gt;&lt;p&gt;从命令行中可以看到，zipline中没有载入任何数据包。然后我们开始下载数据包，具体可以参考&lt;a href=&quot;https://blog.ihanai.com/2018/04/08/install-and-config-zipline/&quot;&gt;Zipline 的安装配置&lt;/a&gt;。下载数据包主要分为两步：&lt;/p&gt;&lt;p&gt;&lt;b&gt;第一步&lt;/b&gt;：登录&lt;a href=&quot;https://www.quandl.com/account/api&quot;&gt;quandl&lt;/a&gt;官网，进行注册，获得api key。&lt;/p&gt;&lt;p&gt;&lt;b&gt;第二部&lt;/b&gt;：设置api key，并下载数据包，具体命令如下：&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;# 设置quandl的api key
set QUANDL_API_KEY=your_key

# 下载数据包
zipline ingest -b quandl

# 查询数据包
 zipline bundles
# 返回
csvdir &amp;lt;no ingestions&amp;gt;
quandl 2018-07-23 09:34:37.144466
quandl 2018-07-23 09:28:37.817531
quantopian-quandl &amp;lt;no ingestions&amp;gt;&lt;/code&gt;&lt;p&gt;当zipline bundles 返回的quandl中出现上面的返回，说明数据下载成功。&lt;/p&gt;&lt;h2&gt;3. 策略代码&lt;/h2&gt;&lt;code lang=&quot;text&quot;&gt;from datetime import datetime

import matplotlib.pyplot as plt
import pytz
import seaborn as sns
import talib as ta
from empyrical import cum_returns, annual_return, sharpe_ratio, max_drawdown
from matplotlib.dates import DateFormatter
from zipline import run_algorithm
from zipline.api import symbol, order, record
from zipline.finance import commission, slippage


def initialize(context):
    # 记录股票代码，通过股票代码获取股票对象
    context.asset = symbol(&#39;AAPL&#39;)

    # 定义是否买入股票的标记
    context.invested = False

    # 设置交易的手续费，股票成交时，手续费按成交金额一定比例收取
    # 设置手续费率和最低费用
    context.set_commission(commission.PerShare(cost=.0075, min_trade_cost=1.0))

    # 设置模拟真实交易的滑价，当实际下单交易时，下单订单将影响市场。买单驱使价格上涨，卖单驱使价格下滑;
    # 这通常被称为交易的“价格影响”。价格影响的大小取决于订单与当前交易量相比有多大。
    context.set_slippage(slippage.VolumeShareSlippage(volume_limit=0.025, price_impact=0.1))


def handle_data(context, data):
    # 获取历史股票数据
    # context.asset表示股票列表
    # fields – 历史数据项或集合，项可以为’close’, ‘open’, ‘high’, ‘low’, ‘price’
    # bar_count – 获取多少单位时间
    # frequency – 可以取值‘1m’ 或 ‘1d’。 ‘1m’表示分钟单位, ‘1d’表示日单位, 现在只支持日单位
    trailing_window = data.history(context.asset, [&#39;high&#39;, &#39;low&#39;, &#39;close&#39;, &#39;open&#39;], 40, &#39;1d&#39;)

    # 数据为空则返回
    if trailing_window.isnull().values.any():
    return

    # 计算cci指标
    cci = ta.CCI(trailing_window[&#39;high&#39;].values, trailing_window[&#39;low&#39;].values, trailing_window[&#39;close&#39;].values,
    timeperiod=14)

    # 定义买入和卖出的标志位
    buy = False
    sell = False

    if (cci[-1] &amp;gt;= 50) and not context.invested:
    # 买卖股票，按股票数量生成订单，amount为负，表示做空。
    # 参数:
    # asset – 股票
    # amount – 交易数量, 正数表示买入, 负数表示卖出
    # style –（可选参数）指定下单类型，默认为市价单，可用的下单类型如下：
    #   style=MarketOrder()，下市价单
    #   style=StopOrder(stop_price)，下止损单，通常用来止损或者锁定利润
    #   style=LimitOrder(limit_price)，下限价单，限定一个价格买入或卖出
    #   style=StopLimitOrder(limit_price=price1, stop_price=price2)，指定限价和止损价格
    order(context.asset, 100)
    # 设置买入
    context.invested = True
    buy = True
    elif (cci[-1] &amp;lt; 50) and context.invested:
    order(context.asset, -100)
    context.invested = False
    sell = True

    # 记录函数，在交易执行时记录用户自定义数据，该数据存放在回测输出结果中
    record(open=data.current(context.asset, &quot;open&quot;),
        high=data.current(context.asset, &quot;high&quot;),
        low=data.current(context.asset, &quot;low&quot;),
        close=data.current(context.asset, &quot;close&quot;),
        cci=cci[-1],
        buy=buy,
        sell=sell)


# 定义分析回测效果的函数
def analyze(context=None, results=None):
    pass


def draw_return_rate_line(result):
    sns.set_style(&#39;darkgrid&#39;)
    sns.set_context(&#39;notebook&#39;)
    ax = plt.axes()
    # 设置时间显示格式
    years_fmt = DateFormatter(&#39;%Y-%m-%d&#39;)
    ax.xaxis.set_major_formatter(years_fmt)
    # 让x轴坐标旋转45度
    labels = ax.get_xticklabels()
    plt.setp(labels, rotation=35, horizontalalignment=&#39;right&#39;)
    # 画出收益率曲线
    sns.lineplot(x=&#39;period_close&#39;,
    y=&#39;algorithm_period_return&#39;,
    data=result,
    label=&quot;AAPL&quot;)
    sns.lineplot(x=&#39;period_close&#39;,
        y=&#39;benchmark_period_return&#39;,
        data=result, label=&quot;SPX&quot;)

    plt.legend(loc=&#39;upper left&#39;)
    plt.title(&quot;return rate of AAPL and SPX&quot;)
    plt.xlabel(&#39;time&#39;)
    plt.ylabel(&#39;return rate&#39;)
    plt.show()


if __name__ == &#39;__main__&#39;:
    capital_base = 10000
    start = datetime(2015, 1, 1, 0, 0, 0, 0, pytz.utc)
    end = datetime(2017, 1, 1, 0, 0, 0, 0, pytz.utc)

    # 运行算法
    result = run_algorithm(start=start, end=end, initialize=initialize,
        capital_base=capital_base, handle_data=handle_data,
        bundle=&#39;quandl&#39;, analyze=analyze)

    # 画出收益曲线图
    draw_return_rate_line(result)

    return_list = result[&#39;returns&#39;]

    # 计算年化收益率
    ann_return = annual_return(return_list)

    # 计算累计收益率
    cum_return_list = cum_returns(return_list)

    # 计算sharp ratio
    sharp = sharpe_ratio(return_list)

    # 最大回撤
    max_drawdown_ratio = max_drawdown(return_list)

    print(&quot;年化收益率 = {:.2%}, 累计收益率 = {:.2%}, 最大回撤 = {:.2%}, 夏普比率 = {:.2f} &quot;.format
        (ann_return, cum_return_list[-1], max_drawdown_ratio, sharp))&lt;/code&gt;&lt;hr&gt;&lt;p&gt;如果你对我的文章有兴趣，可以关注一下我的简书和知乎，后期会在简书和知乎上定期更新，传送门在下方：&lt;br&gt;&lt;b&gt;简书&lt;/b&gt;：&lt;a href=&quot;https://www.jianshu.com/u/d436b7e60253&quot;&gt;潇潇夜雨归何处&lt;/a&gt;&lt;br&gt;&lt;b&gt;知乎&lt;/b&gt;：&lt;a href=&quot;https://www.zhihu.com/people/edwardzhang0630/activities&quot;&gt;潇潇夜雨&lt;/a&gt;&lt;br&gt;&lt;br&gt;我相信，有趣的灵魂总会相遇！！！&lt;br&gt;&lt;br&gt;你的关注，是我前进的动力！！！&lt;/p&gt;</description>
<author>潇潇夜雨</author>
<guid isPermaLink="false">2018-07-25-40565731</guid>
<pubDate>Wed, 25 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>策略||模型校正</title>
<link>https://henix.github.io/feeds/zhuanlan.c_106548378/2018-07-25-40528417.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/40528417&quot;&gt;原文&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;斯蒂文管理着一个交易组合包含着各种资产类 (asset class) 的金融产品。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;老板：有一百万欧元，欧元对美元 (EURUSD) 可能会涨，3 个月后 锁定一个汇率换成美元&lt;/p&gt;&lt;p&gt;斯蒂文：买 EURUSD 看涨期权 (call option)&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;老板：美元三个月同业拆放利率 (USD Libor3M) 可能会降，1 年后 锁定一个利率赚利差&lt;/p&gt;&lt;p&gt;斯蒂文：买 USD 利率下限 (IR floor)&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;老板：咖啡价格 3 个月可能会涨，抓住它的平均涨幅&lt;/p&gt;&lt;p&gt;斯蒂文：买咖啡亚式固定行权看涨期权(Asian fixed strike calloption)&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;老板：通用汽车 (GM) 在 1 年内可能会涨，但是一旦超过 38 就不 会跌破 30&lt;/p&gt;&lt;p&gt;斯蒂文；买 GM 向上敲出障碍看跌期权 (up-and-out put option)， 障碍价位 38，行权价为 30。 &lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;要买这么多金融衍生品，以什么价格买?这可不是简单的折现现金流(discounted cash flow) 就可以算出来，都需要对其原生资产 (underlying asset) 价格进行建模。原因很简单，衍生品的价值是原生资产价格的函数。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;• 外汇看涨期权的价值是汇率价格的函数 &lt;/p&gt;&lt;p&gt;• 利率下限的价值是利率价格的函数&lt;/p&gt;&lt;p&gt;• 商品亚式期权的价值是商品价格的函数 &lt;/p&gt;&lt;p&gt;• 股权障碍期权的价值是股票价格的函数&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;但是产品定价 (instrument pricing) 易，模型校正 (model calibration) 难， 因为&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;• 定价是个正问题，给定模型参数算出产品价格&lt;/p&gt;&lt;p&gt;• 校正是个反问题，给定产品价格反推模型参数 &lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;为了让大家保持兴趣，现在来看看两个最简单的定价和校正：&lt;/p&gt;&lt;ol&gt;&lt;li&gt;定价问题是1 + 2 = 3，把加法看成是个“模型”，那么与之对应的校正问题就是 1 加上多少等于 3，校正 (用减法3 - 1) 出来的结果是2。&lt;/li&gt;&lt;li&gt;定价问题是sin(π/6) = 0.5，把正弦函数看成是个“模型”，那么与之对应的校正问题就是sin多少等于0.5，校正 (用反正弦argsin(0.5)) 出来的结果是π/6 。&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;虽然上面两例“校正”不难，但也比“定价”难吧。在量化金融中，用复杂模型的定价问题已经不易，那么相对应的校正问题更加困难，如：&lt;/p&gt;&lt;p&gt;定价问题是BS(σ) = 1美元，把BS看成是个模型，那么与之对应的校正问题就是多少波动率σ带入BS公式里得到期权价值1美元。&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;本推文就为大家展示各种资产类的常见模型的模型校正！里面画的图全是基于真实的市场数据，而作者也有一套系统的程序来实现各种模型校正。&lt;b&gt;出于里面有些技巧是公司或客户的私有财产和作者多年以来的心血，作者还是不发整套代码怕担当法律责任，但是有问必答！&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;前戏王&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;0.1 模型参数形式&lt;/b&gt;&lt;/p&gt;&lt;p&gt;在金融模型中，时间 t 是个很重要的变量，而模型参数 c 通常认为和 t 有 关，写作 c(t)。在建模时，将 c(t) 的整个函数形式完全描述出来不容易也 不实际，通常把 c(t) 看成是常数形式和分段常数形式，如下图: &lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-ecb5b856aebdd09cb131ab0735166c03_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;438&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-ecb5b856aebdd09cb131ab0735166c03&quot; data-watermark-src=&quot;v2-b0e9518b7ca1f872c5e0669db743e37b&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;给定时间结构 t0 &amp;lt; t1 &amp;lt; ... &amp;lt; ti-1 &amp;lt; ... &amp;lt; tn，常数和分段常数的表达形式如下表所示 &lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-3662d2ac0bc65897eff7d5970c8ade8d_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;582&quot; data-rawheight=&quot;186&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-3662d2ac0bc65897eff7d5970c8ade8d&quot; data-watermark-src=&quot;v2-81e4fdbd5463723dd87c7168de5010a8&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;0.2 随机微分方程&lt;/b&gt;&lt;/p&gt;&lt;p&gt;随机微分方程 (SDE) 就是常微分方程 (ODE) 加个随机过程。在各种金融 衍生品模型中，其对应的原生资产都能用 SDE 来描述。比如股票类Black-Scholes 模型，利率类 Hull-White 模型，商品类 Schwartz 模型和外 汇类 Heston 模型相对应的 SDE 如下：&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-f76f848fb70a024f1bf043cb42c55d23_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;336&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-f76f848fb70a024f1bf043cb42c55d23&quot; data-watermark-src=&quot;v2-c965afb51a3f170f92887f801bda0511&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;我们可以不严谨把 SDE 当成模型，而里面红色项就是模型参数，这些参数都不是随意给定，而是从金融市场中“校正”出来的。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;股权类&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;1.1 Black-Scholes 模型&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;模型介绍&lt;/b&gt;&lt;/p&gt;&lt;p&gt;股权类的 Black-Scholes (BS) 模型下的 SDE 是描述股票价格 (stock price) 的走势：&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-222a895052e30100308fed7cea8fe089_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;77&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;其中&lt;/p&gt;&lt;p&gt;S(t) = 股票价格&lt;/p&gt;&lt;p&gt;r(t) = 瞬时无风险利率&lt;/p&gt;&lt;p&gt;q(t) = 瞬时红利率&lt;/p&gt;&lt;p&gt;ς(t) = S(t)的瞬时波动率 &lt;/p&gt;&lt;p&gt;B(t) = 布朗运动&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;该模型是 Fischer Black 和 Myron Scholes 在 1973 年提出，其论文题目是 &lt;i&gt;The Pricing of Options and Corporate Liabilities&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;模型参数&lt;/b&gt;&lt;/p&gt;&lt;p&gt;一般情况下&lt;/p&gt;&lt;p&gt; r(t) 和 q(t) 当成常数&lt;/p&gt;&lt;p&gt; ς( ) 可以是常数，但通常是分段常数 &lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;它们的获取方式为&lt;/p&gt;&lt;ul&gt;&lt;li&gt;r：根据股票结算的货币，找到其掉期曲线，如美元对应 USD Libor 3M 曲线，欧元对应 EUR Euribor 6M 曲线等，在曲线上插出 T 点 的r值&lt;/li&gt;&lt;li&gt;q：根据该股票在估值日和到期日 T 之间的所有离散红利，折现到 0 点得到红利现值 div，再利用公式 div = e-qT 计算出 T 点的 q 值， q = -ln(div/T)&lt;/li&gt;&lt;li&gt; ς 或 ς( ) :从一系列股权欧式期权中校正出来&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;1.2 市场标准产品和数据&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;产品定义&lt;/b&gt;&lt;/p&gt;&lt;p&gt;股权类市场标准产品是“一系列不同行权价格 K 和不同年限 T 股权欧式 期权 (EQ option)”，定义如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;在股权欧式期权 (equity vanilla option) 合约下，买方和卖方将同意以下内容：&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 买方付出期权金 (premium) 便有权利 (right)去行使，而卖方收取 期权金后则有义务 (obligation) 履行买方行使权利的义务。&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 看涨期权:买方有权在到期日以 K 买入 S，而卖方一旦被行使期权 时，则有责任以 K 卖出 S&lt;/li&gt;&lt;li&gt; 看跌期权:买方有权在到期日以 K 卖出 S，而卖方一旦被行使期权 时，则有责任以 K 买入 S&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;其中 S 是到期日股权的价格，K 是执行价格 (strike price)。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;市场数据&lt;/b&gt;&lt;/p&gt;&lt;p&gt;它们的成交价就是用于模型校正的市场数据，但市场惯例是用波动率当市 场数据，原因是价格在价内和价外是差别会很大，而波动率是一个没有单 位的量。某天的日经平均指数 (N225) 的真实数据如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-472a564b35e7a7e46b4ab38780f925fb_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;148&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-472a564b35e7a7e46b4ab38780f925fb&quot; data-watermark-src=&quot;v2-d5527f5c1d9beb2e48b920ea8c1173e0&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;上图数据又称 EQ option 波动率平面，它是二维数据结构&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 行对应的年限 (expiry)，期权年限从 1 个月到 5 年&lt;/li&gt;&lt;li&gt; 列对应的行权价格 (strike)，注意第三列白色粗体 17450.77 是&lt;/li&gt;&lt;li&gt;ATM 行权价格，其对应的绿色粗体是 ATM 波动率&lt;/li&gt;&lt;li&gt; 波动率与行权价格和年限有关，可写成 ς(K, T)&lt;/li&gt;&lt;li&gt; 波动率单位是%，28.63 实际上指的是 28.63%&lt;/li&gt;&lt;li&gt; 市场波动率带进 BS 公式得到期权的市场价格&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;1.3 市场价格和模型价格&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;市场价格&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-a5929135e8070fa00c92e8d1cca8eed9_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;195&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-a5929135e8070fa00c92e8d1cca8eed9&quot; data-watermark-src=&quot;v2-be5b161afd4186e076f0faeae0769219&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;EQ option 市场价格是之后模型校正的基准 (benchmark)。关于 BS 模型的 EQ option 公式推导细节，可参考 &lt;i&gt;Options, Futures And Other Derivatives, 9th edition, Chapter15, Appendix.&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;模型价格&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-75f3f99ee795e63a39472631593d6acc_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;176&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-75f3f99ee795e63a39472631593d6acc&quot; data-watermark-src=&quot;v2-c2f0287ad1f09c384412e7c43e515784&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-58433216e55a62af703dda68d8f3a78a_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;240&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-58433216e55a62af703dda68d8f3a78a&quot; data-watermark-src=&quot;v2-f9d352ee22ac8067414f37a09ec0b6ca&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;当模型参数为 t 的函数时，关于 BS 模型的 EQ option 公式推导细节，可参考 &lt;i&gt;Volatility and Correlation, 2th edition, Chapter3.&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;1.4 模型校正&lt;/b&gt;&lt;/p&gt;&lt;p&gt;在 EQ option 市场上，对每一个标准 K 有 n 个到期的 EQ option，到期日分别为&lt;/p&gt;&lt;p&gt;0 = T0 &amp;lt; T1 &amp;lt; ... &amp;lt; i &amp;lt; ... &amp;lt; n&lt;/p&gt;&lt;p&gt;而对于每一个 Ti，EQ option 的行权价格为 K1 ... j ... m。 接下来我们分别讨论当模型参数为常数和分段常数是的校正过程。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;常数型参数&lt;/b&gt;&lt;/p&gt;&lt;p&gt;当参数为常数时，BS 模型校正本质上是找到“最优”ς，从而最小化一系列 EQ option 的市场价格和模型价格之间的差异，其目标函数为:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-f034c6378e67077e5e37e8d51c1cd0d1_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;210&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-f034c6378e67077e5e37e8d51c1cd0d1&quot; data-watermark-src=&quot;v2-c6ae9067a11f318c2d6475a8e68e0c8a&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;其中&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Vmkt是 EQ option 市场价格，惯例是用 BS 公式计算的&lt;/li&gt;&lt;li&gt;ςmkt(K, T) 是 EQ option 市场波动率，有 n 个 T 和 m 个 K&lt;/li&gt;&lt;li&gt;VBS 是 EQ option 模型价格&lt;/li&gt;&lt;li&gt;ς 是 BS 模型的模型参数&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;分段常数型参数&lt;/b&gt;&lt;/p&gt;&lt;p&gt;当参数为分段常数时，对每一个标准 K，市场上都有一系列 Ti 到期的 EQ option，由上面公式发现期权价格 V 是 ς2(t) 积分的函数，如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-fbbfa5ea8fbc52e67ba2c8f64a9eb324_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;279&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-fbbfa5ea8fbc52e67ba2c8f64a9eb324&quot; data-watermark-src=&quot;v2-7c6ac09f29e7ab5a205aebd3e197616d&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;注意 ς0-i 是从 0 到 Ti 的波动率 ς(t )的均方根 (root-mean-square)，而它们可以直接反解 BS公式得到。之后我们可以得到从 Ti 到 Ti+1&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-c67569762f36bd35e8aaa663dc8f91f5_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;216&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-c67569762f36bd35e8aaa663dc8f91f5&quot; data-watermark-src=&quot;v2-9d26d00ae0dcc5fdbbe5aa8625d33740&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;上面公式建立了即期波动率到远期波动率的关系，而这个关系通常称为方 差平衡条件 (balance-of-variance condition)。具体步骤如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;步骤 1&lt;/b&gt; - 在每个 Kj 下的所有年限 T 上计算:即期方差 = ς2mkt*T&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-a68e6b484fb11a6323672977721d2fbd_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;199&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-a68e6b484fb11a6323672977721d2fbd&quot; data-watermark-src=&quot;v2-bf61a7e8bd4488fe2de9cfb9dbcd7cf5&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;步骤 2&lt;/b&gt;- 用方差平衡条件从即期方差推出远期波动率，如下表所示&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-3938fa5280ec8a5c4ee991a3eabc7416_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;311&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-3938fa5280ec8a5c4ee991a3eabc7416&quot; data-watermark-src=&quot;v2-d226aaac03b006958943d217ca7908fb&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;#BS模型校正代码
spot_var = spot_vol.*2.*Te
for i = 1 : size(spot_vol,2)
    fwd_Vol(:,i) = sqrt( diff([0; spot_var(:,i)]) ./ diff([0;Te]) )
end&lt;/code&gt;&lt;p&gt;在做模型校正的同时，一旦我们发现下面的关系，那么就有套利机会。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-a75b1aa33ce12bc15dd138855f752de3_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;148&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-a75b1aa33ce12bc15dd138855f752de3&quot; data-watermark-src=&quot;v2-3527cfb65ae78386bbf1d7ea73fdbf0c&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;上式意思就是股票价格到 Ti+1 的不确定性比到 Ti 的不确定性还小，这显然违背常理。如果有这种机会出现，买 Ti+1 到期的便宜期权，卖 Ti 到期 的昂贵期权。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;1.5 校正结果&lt;/b&gt;&lt;/p&gt;&lt;p&gt;下图展示着 N225 option 的市场价格 (红圈) 和模型价格 (蓝线)，发现它们在不同 K 和 T 时都高度吻合。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-9cca54dc8e91829579520f6cfeceeb37_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;560&quot; data-rawheight=&quot;420&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-9cca54dc8e91829579520f6cfeceeb37&quot; data-watermark-src=&quot;v2-10875c5776b5346c65c600ac244b4e68&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;下图展示着在不同 K 下的分段常数 ς( )，基本上 ς( ) 是 t 的增函数，走 势正常。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-41fdd5321499a2c42e80e2616ae2e90c_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;560&quot; data-rawheight=&quot;420&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-41fdd5321499a2c42e80e2616ae2e90c&quot; data-watermark-src=&quot;v2-0c8f2a77c50bc2c23da7c14d17fa4373&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;利率类&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;2.1 Hull-White 模型&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;模型介绍&lt;/b&gt;&lt;/p&gt;&lt;p&gt;利率类的 Hull-White (HW) 模型下的 SDE 是描述短期利率 (short rate) 的走势:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-36f684652e2299f6a88a482a4e1f3f6b_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;41&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;其中&lt;/p&gt;&lt;ul&gt;&lt;li&gt;r(t) = 短期利率&lt;/li&gt;&lt;li&gt;k( )=r(t)的均值回归速率&lt;/li&gt;&lt;li&gt;ς( )=r(t)的均值&lt;/li&gt;&lt;li&gt;6(t)= r(t)的波动率&lt;/li&gt;&lt;li&gt;B(t) = 布朗运动&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;该模型是 John Hull 和 Alan White 在 1990 年提出，其论文题目是&lt;/p&gt;&lt;p&gt;&lt;i&gt;Pricing Interest-Rate Derivative Securities&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;模型参数&lt;/b&gt;&lt;/p&gt;&lt;p&gt;一般情况下&lt;/p&gt;&lt;ul&gt;&lt;li&gt;k (t) 当成常数&lt;/li&gt;&lt;li&gt; 6(t) 可以是常数，但通常是分段常数 &lt;/li&gt;&lt;li&gt;ς(t )是 t 的函数&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;它们的获取方式为&lt;/p&gt;&lt;ul&gt;&lt;li&gt;k：根据历史数据人为设定，也可以从一系列利率期权中校正出来 &lt;/li&gt;&lt;li&gt;6或 6(t)：从一系列利率期权中校正出来&lt;/li&gt;&lt;li&gt;ς( )：从收益率曲线中校正出来&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-70dbeacc7c93b617dfcd8ec29d978adc_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;62&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;其中 f(0, t)是 0 点观察到的 t 点瞬时远期利率&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;为了消除 ( ) 这个复杂项，令 x(t) = r(t) – f(0, t)，那么 x(0) = r(0) –f(0,0) = 0。原来 r(t) 的 SDE 转换成 x(t) 的 SDE:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-34a77508898cd3624831e3311f303a42_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;31&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-1c988fcfeb822979c554eb47a89ab387_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;55&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;这样在 HW 模型下的零息债券的公式如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-7e863eb8b51ec0e50c0c67a00a8b43fd_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;63&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-5780aeaca84cae5cacdadbc5509bd15e_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;64&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;关于上面 ( ) 和 P(t, T) 推导细节，可以参考 &lt;i&gt;Interest Rate Modeling Volumn II, Term Structure Model, Chapter 10, 10.1.2.2.&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;2.2 市场标准产品和数据&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;产品定义&lt;/b&gt;&lt;/p&gt;&lt;p&gt;利率类市场标准产品包括:&lt;/p&gt;&lt;p&gt;1. 一系列不同行权价格 K 和不同年限 T 利率上限 (cap)&lt;/p&gt;&lt;p&gt;2. 一系列不同行权价格 K，不同期权年限 TO 和不同掉期年限 TU 利率&lt;/p&gt;&lt;p&gt;掉期期权 (swaption) Cap 和 swaption 定义如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;Cap 和 swaption 定义如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;在利率上限或下限 (interest rate cap/floor) 合约下，买方和卖方将同意以 下内容:&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 买方付出期权金 (premium) 便有权利 (right) 去行使，而卖方收取期权金后则有义务 (obligation) 履行买方行使权利的义务。&lt;/li&gt;&lt;li&gt; 双方就未来某一时期商定一个固定利率 K 作为利率上限/下限&lt;/li&gt;&lt;li&gt; 上限：买方有权利在每期获得市场利率 L 与上限利率 K 的差额 (L – K)，而卖方一旦被行使期权时，则有义务将市场利率 L 与上限利率 K 的差额支付给买方&lt;/li&gt;&lt;li&gt; 下限：买方有权利在每期获得下限利率 K 和市场利率 L 的差额 (K – L)，而卖方一旦被行使期权时，则有义务将下限利率 K 和市场利率 L 的差额支付给买方&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;其中 L 通常是 LIBOR，但是不是当期定盘，而是上一期定盘的 LIBOR。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;市场上流动性强的 cap 以美元、欧元和日元计价，每个 cap 都一连串 caplet 组成&lt;/p&gt;&lt;ul&gt;&lt;li&gt; USD cap 每年由 4 个 caplet 组成，每个 caplet 期限是 3 个月，以 USD LIBOR 3M 作标的利率&lt;/li&gt;&lt;li&gt; EUR cap 每年由 2 个 caplet 组成，每个 caplet 期限是 6 个月，以 EUR EURIBOR 6M 作标的利率&lt;/li&gt;&lt;li&gt; JPY cap 每年由 2 个 caplet 组成，每个 caplet 期限是 6 个月，以 JPY LIBOR 6M 作标的利率&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;在利率掉期期权 (interest rate swaption) 合约下，买方和卖方将同意以下 内容:&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 买方付出期权金 (premium) 便有权利 (right) 去行使，而卖方收取 期权金后则有义务 (obligation) 履行买方行使权利的义务。&lt;/li&gt;&lt;li&gt; 支付类掉期期权 (payer swaption):买方有权利在期权到期日获得 一个“支付固定利率接受浮动利率 (pay fixed receive floating) 的利率 掉期”，而卖方一旦被行使期权时，则有义务将上述利率掉期给买 方&lt;/li&gt;&lt;li&gt; 接受类掉期期权 (payer swaption):买方有权利在期权到期日获得一个“接受固定利率支付浮动利率 (receive fixed pay floating) 的利率 掉期”，而卖方一旦被行使期权时，则有义务将上述利率掉期给买 方&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;其中利率掉期 (interest rate swap, IRS) 是指交易双方以一定的名义本金为 基础，将该本金产生的一种利率计算的利息收入 (支出) 与另一种利率计 算的利息收入 (支出)。交换的只是不同特征的利息，没有实质本金的互 换。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;市场上流动性强的以美元、欧元和日元计价的 swaption。其实 swaption 波动率是一个立方 (cube)，有行权利率、期权到期日、掉期到期日这三 个维度。通常我们用的最多的是 ATM swaption 波动率，当行权利率等于 远期掉期率，那么波动率立方降维成一个波动率平面，维度为二维。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;市场数据&lt;/b&gt;&lt;/p&gt;&lt;p&gt;某天的 JPY cap 的真实数据如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-148e1017173dc2e4a6e142db8b0fc9a0_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;199&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-148e1017173dc2e4a6e142db8b0fc9a0&quot; data-watermark-src=&quot;v2-e2ab3ccce5b93352d63af90584d4497e&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;上图数据又称 cap 波动率平面，它是二维数据结构&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 行对应的年限 (expiry)，期权年限从 1 年到 20 年&lt;/li&gt;&lt;li&gt; 列对应的行权利率 (strike rate)，注意第一列绿色粗体是 ATM 波动率，而每个年限对应的 ATM 行权利率都不同&lt;/li&gt;&lt;li&gt; 波动率与行权价格和年限有关，可写成 ς(K, T)&lt;/li&gt;&lt;li&gt; 波动率单位是 %，43.01 实际上指的是 43.01%&lt;/li&gt;&lt;li&gt;市场波动率带进 Black 公式得到利率上限的市场价格&lt;br&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;某天的 USD ATM swaption 的真实数据如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-df05513cb349e28c6fc24e0dabacec42_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;187&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-df05513cb349e28c6fc24e0dabacec42&quot; data-watermark-src=&quot;v2-842e1849552671470db6fc5eda785ca7&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;上图数据又称 ATM swaption 波动率平面，它是二维数据结构&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 行对应的利率掉期的年限 (maturity)，年限从 1 年到 30 年&lt;/li&gt;&lt;li&gt; 列对应的掉期期权的年限 (expiry)，年限从 1 个月到 30 年&lt;/li&gt;&lt;li&gt; ATM 波动率与期权年限和掉期年限有关，可写成 ς(TO, TU)&lt;/li&gt;&lt;li&gt; 波动率单位是%，59.80 实际上指的是 59.80%&lt;/li&gt;&lt;li&gt;市场波动率带进 Black 公式得到掉期期权的市场价格&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;2.3 市场价格和模型价格&lt;/b&gt;&lt;/p&gt;&lt;p&gt;定义T0 &amp;lt;T1 &amp;lt;...&amp;lt; k &amp;lt;...&amp;lt; N 是cap 的年限结构，那么定义&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;{T0, T1, ..., TN-1} = LIBOR 定盘日 &lt;/p&gt;&lt;p&gt;{T1, T2, ..., TN} = 支付日&lt;/p&gt;&lt;p&gt;N = caplet 的个数&lt;/p&gt;&lt;p&gt;τk =Tk–Tk-1&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Cap 市场价格&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;Cap 市场价格是之后模型校正的基准 (benchmark)。关于 Black 模型的 cap 推导细节，可以参考 &lt;i&gt;Interest Rate Model – Theory and Practice, Chapter 1 and Appendix D.&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-44366d83f6a1984c89d1dc084cd145df_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;288&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-44366d83f6a1984c89d1dc084cd145df&quot; data-watermark-src=&quot;v2-ce8cdcd1b01290164f9b21e43341cc75&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Cap 模型价格&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-98bad03dfee7c7d17ba177441d8c635e_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;269&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-98bad03dfee7c7d17ba177441d8c635e&quot; data-watermark-src=&quot;v2-5a60ed797fc1ce330ed6df5bb7a18e42&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;当模型参数为常数时，关于 HW 模型的 cap 推导细节，可以参考 &lt;i&gt;Interest Rate Model – Theory and Practice, Chapter 3.&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;function price = HW_IRO( omega, Ds, De, Ts, Te, tau, K, kappa, sigma )

X = 1 + K*tau;
price = X .* HW_ZBO( -omega, Ts, Te, Ds, De, 1./X, kappa, sigma );
end
--------------------------------------
function price = HW_ZBO( omega, T1, T2, PT1, PT2, X, kappa, sigma )

tau = T2 - T1;

if kappa &amp;lt; 1e-12    
    sigmaP = sigma * tau .* sqrt(T1);
else
    sigmaP = sigma * sqrt((1-exp(-2*kappa*T1))/2/kappa) /kappa .* (1- exp(-kappa*tau));
end

h1 = (1./sigmaP) .* log(PT2./(PT1.*X)) + sigmaP/2;
h2 = h1 - sigmaPprice = omega * ( PT2.*normcdf(omega*h1) - X.*PT1.*normcdf(omega*h2) )

end&lt;/code&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-5ed17be97c36fbd1630c8dcdeb10d965_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;272&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-5ed17be97c36fbd1630c8dcdeb10d965&quot; data-watermark-src=&quot;v2-98582bf8cf339adc80ff8d561654c041&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Swaption 市场价格&lt;/b&gt;&lt;/p&gt;&lt;p&gt;定义T0 &amp;lt;T1 &amp;lt;...&amp;lt; k &amp;lt;...&amp;lt; N 是swaption 的年限结构，那么定义&lt;/p&gt;&lt;ul&gt;&lt;li&gt;T0 = swaption 到期日 &lt;/li&gt;&lt;li&gt;TN = swap 到期日&lt;/li&gt;&lt;li&gt;τk =Tk–Tk-1&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-76653f11f91e59ee2fc79239e3f387de_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;312&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-76653f11f91e59ee2fc79239e3f387de&quot; data-watermark-src=&quot;v2-525eea7a0479c969be46ab0a5201fa4a&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;Swaption 市场价格是之后模型校正的基准 (benchmark)。关于 Black 模 型的 Swaption 推导细节，可以参考 &lt;i&gt;Interest Rate Model – Theory and Practice, Chapter 1 and Appendix D.&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Swaption 模型价格&lt;/b&gt;&lt;/p&gt;&lt;p&gt;Swaption 可看成在期权到期日 T1 时交换 IRS 的固定端和浮动端，因此它在 T1 的支付函数为&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-baa029ae64217e4dec8dbc6e82d45701_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;67&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;由小节 2.1 可知 P(t, T;x)是 x 的减函数，因此定义一个临界值 x* 使得&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-b89dcea4870f45c9fec9314a4dd90c20_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;232&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-b89dcea4870f45c9fec9314a4dd90c20&quot; data-watermark-src=&quot;v2-7c3d5a13a982671d5c3c82774483d987&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;其中&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-4d25f76e4522fd5dce064baced457707_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;39&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;根据 Jamshidian Trick，swaption 只有在 w x(T1) &amp;gt; * 时才有 payout， 为了简化符号引进 P1,k(x) = P(T1,Tk, x)，我们有&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-1c45813d0e81e415a9b27d5b701f1b08_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;136&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-1c45813d0e81e415a9b27d5b701f1b08&quot; data-watermark-src=&quot;v2-60ecfb7178958f44f28f5a71e1921777&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;最后 swaption 在 T1 的 payout 可表示为一系列的零息债券期权 (zero- coupon bond option, ZBO) 在的 payout，因此其价值为这些 ZBO 的价值 的组合。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-59764b769adc4bef96bee49a8926b885_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;329&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-59764b769adc4bef96bee49a8926b885&quot; data-watermark-src=&quot;v2-16d62d1d7d03a5ff358f91b3fc8b150b&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;#计算 HW Swaption 代码
function price = HW_Swaption( D, Tvec, tau, c, kappa, sigma )
Pt = D(1); PT = D(2:end); t = Tvec(1); T = Tvec(2:end);
x_star = fzero( @(x) Jamshidian( Pt, PT, kappa, sigma, t, T, c, tau, x ), 0 );
K = HW_zcb( Pt, PT, kappa, sigma, t, T, x_star )&#39;;

price = HW_ZBO( -1, t, T(end), Pt, PT(end), K(end), kappa, sigma ) ... + c*sum( tau.*HW_ZBO( -1, t, T, Pt, PT, K, kappa, sigma ) );
end
function y = Jamshidian( Pt, PT, kappa, sigma, t, T, c, tau, x )
y = HW_zcb(Pt, PT(end), kappa, sigma, t, T(end), x) ...
+ c*sum( tau.*HW_zcb(Pt, PT, kappa, sigma, t, T, x)&#39; ) - 1;
end
--------------------------------------
function PtT = HW_zcb( Pt, PT, kappa, sigma, t, T, Xt ) 
G = 1-exp(-kappa*(T-t))) / kappa;
y = sigma^2 * (1-exp(-2*kappa*t)) / (2*kappa)
PtT = (PT/Pt) * exp( -Xt*G -0.5*y*G^2 );
end&lt;/code&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-e38e56d9d1f631a954c64861a6cc5b87_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;322&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-e38e56d9d1f631a954c64861a6cc5b87&quot; data-watermark-src=&quot;v2-28b1e39cca7dc59f4dbc7f1453158cfd&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;关于 HW 模型的 swaption 推导细节，可以参考 &lt;i&gt;Interest Rate Modeling – Volumn II, Term Structure Model, Chapter 10, 10.1.3.&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;2.4 模型校正 (cap)&lt;/b&gt;&lt;/p&gt;&lt;p&gt;在 cap 市场上，对每一个标准 K 有 n 个到期的 cap，到期日分别为&lt;/p&gt;&lt;p&gt;0 = T0 &amp;lt; T1 &amp;lt; ... &amp;lt; i &amp;lt; ... &amp;lt; n&lt;/p&gt;&lt;p&gt;而对于每一个 Ti，cap 的行权价格为 K1 ... j ... m。 接下来我们分别讨论当模型参数为常数和分段常数是的校正过程。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;常数型参数&lt;/b&gt;&lt;/p&gt;&lt;p&gt;当参数为常数时，HW 模型校正本质上是找到“最优” 和 ς，从而最小 化一系列 cap 的市场价格和模型价格之间的差异，其目标函数为:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-b2123d4062fd99a43fc886d29174ad6f_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;213&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-b2123d4062fd99a43fc886d29174ad6f&quot; data-watermark-src=&quot;v2-ca880c56fbef6cbe914d3d885d4e0788&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;其中&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Cap 是市场价格，惯例是用 Black 公式计算的&lt;/li&gt;&lt;li&gt;ςmkt(K, T) 是市场波动率，有 n 个 T 和 m 个 K&lt;/li&gt;&lt;li&gt;CapHW 是模型价格&lt;/li&gt;&lt;li&gt;k和 ς 是 HW 模型的模型参数&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;分段常数型参数&lt;/b&gt;&lt;/p&gt;&lt;p&gt;从小节 2.3 的公式出发，&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 用上标i表示每一个K下的第i个cap&lt;/li&gt;&lt;li&gt; 用 Ni 表示该 cap 里面 caplet 的个数&lt;/li&gt;&lt;li&gt; 用tNi 代表第i 个cap 到期日，tNi =Ti&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-cea78b49fcddc88102fb8a336f59e2eb_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;380&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-cea78b49fcddc88102fb8a336f59e2eb&quot; data-watermark-src=&quot;v2-64dec05ec8f477209a6f643d7fb0cda1&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;当参数为分段常数时，假设选取 ATM cap 做校正，那么 HW 模型校正的 步骤为:&lt;/p&gt;&lt;p&gt;步骤 1 - 参数 根据历史数据手动输入，或者用常数形式的 HW 模型校 正得出&lt;/p&gt;&lt;p&gt;步骤 2 - 对第 1 个 cap，反解 ς1 使得 Capmkt(T1) = Cap1HW(ς1)&lt;/p&gt;&lt;p&gt;步骤 3 - 对第 2 个 cap，已知 ς1，反解 ς2 使得 Capmkt(T2) = Cap2HW(ς1,ς2)&lt;/p&gt;&lt;p&gt;步骤 4 - 重复上面过程到第 n 个 cap，已知 ς1, ς2 ... ςn-1，反解 ςn 使得 Capmkt(Tn) = CapnHW(ς1,ς2 ... ςn-1,ςn)&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;%HW 模型校正代码
sigma = zeros(num_of_T,1);
for i = 1 : num_of_T,
    [ itau, iTs, iTe, iDs, iDe ] = reference( (1:nFlt(i)-1), tau, Ts, Te, Ds, De );
    sigma(i) = fzero(@(x) Cap_diff( iDs, iDe, iTs, iTe, itau, K(i), kappa, x, mkt_price(i) ), 0.005 );
end&lt;/code&gt;&lt;p&gt;以上过程把 1 个 n 维的优化问题转成 n 个 1 维的优化问题，增加了模型 校正的效率。需要注意的是，上述步骤并不是每次都行得通，这种情况称 为“波动率紧缩 (volatility squeeze)”，出现在当 Ti+1 到期的 cap 比 Ti 到期的 cap 价格小很多的时候。这种情况很少见，一旦出现可以当成是套 利的信号。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;2.5 模型校正 (swaption)&lt;/b&gt;&lt;/p&gt;&lt;p&gt;在 ATM swaption 市场上，在以下的年限结构上考虑一串特殊的 swaption&lt;/p&gt;&lt;p&gt;0 = T0 &amp;lt; T1 &amp;lt; ... &amp;lt; i &amp;lt; ... &amp;lt; n&lt;/p&gt;&lt;p&gt;此类 swaption 的 option 到期日为 Ti, ... -1，而它们的 swap 到 期日都是 Tn，这样的 swaption 成为 coterminal swaption，记作 aYbY， 指的是 a 年 option 到期可以换一个 b 年 swap 的 swaption。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;由于此类结构和市场交易的百慕大期权 (Bermudan swaption) 很类似，因 此 coterminal swaption 经常被当作校正工具来使用。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;接下来我们分别讨论当模型参数为常数和分段常数是的校正过程。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;常数型参数&lt;/b&gt;&lt;/p&gt;&lt;p&gt;当参数为常数时，HW 模型校正本质上是找到“最优” 和 ς，从而最小 化一系列 coterminal swaption 的市场价格和模型价格之间的差异，其目 标函数为:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-e1274b9d884c293eba89a45975f70345_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;68&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;其中&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Swaption是市场价格，惯例是用 Black 公式计算的 &lt;/li&gt;&lt;li&gt;ςmkt(K, T) 是市场波动率，有 n 个 T 和 m 个 K &lt;/li&gt;&lt;li&gt;Swaption HW是模型价格&lt;/li&gt;&lt;li&gt;k和 ς 是 HW 模型的模型参数 &lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;分段常数型参数&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-a4583276097585f735175eec5d025183_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;348&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-a4583276097585f735175eec5d025183&quot; data-watermark-src=&quot;v2-b66a0945174f3628224b40e37d60653f&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;当参数为分段常数时，选取 ATM coterminal swaption 做校正，那么 HW 模型校正的步骤为:&lt;/p&gt;&lt;p&gt;步骤 1 - 参数 根据历史数据手动输入，或者用常数形式的 HW 模型校 正而得&lt;/p&gt;&lt;p&gt;步骤 2 - 对第 1 个 swaption，反解 ς1 使得 swaptionmkt(T1) = swaption1HW(ς1)&lt;/p&gt;&lt;p&gt;步骤 3 - 对第 2 个 swaption，已知 ς1，反解 ς2 使得 swaptionmkt(T2) = swaption2HW(ς1,ς2)&lt;/p&gt;&lt;p&gt;步骤 4 - 重复上面过程到第 n-1 个 swaption，已知 ς1, ς2 ... ςn-2，反解 ςn- 1 使得 swaptionmkt(Tn-1) = swaptionn-1HW(ς1,ς2 ... ςn-2,ςn-1)&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;#HW 模型校正代码
sigma = zeros(num_of_T,1);
for i = 1 : num_of_T,
    T = getTenor( settle, fixedLegDate{i}, &#39;act/365&#39; );
    D = getDiscount( settle, spotDate, fixedLegDate{i}, LiborCurve ); 
    [ iT, iD ] = reference( 1:nFix(i), T, D );
    sigma(i) = fzero(@(x) Swaption_diff( iD, iT, fixtau{i,i}, K(i),
kappa, x, mkt_price(i) ), 0.005 );     
end&lt;/code&gt;&lt;p&gt;和 cap 校正是遇到的问题一样，波动率紧缩也是 swaption 的校正可能出 现的问题。该情况出现在当 Ti+1 到期的 swaption 比 Ti 到期的 swaption 价格小很多的时候。这种情况很少见，一旦出现可以当成是套利的信号。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;2.6 校正结果&lt;/b&gt;&lt;/p&gt;&lt;p&gt;下图展示着当 和 ς 为常数时，USD ATM cap 的市场价格 (红圈) 和模型 价格 (蓝线)，发现它们在不同 T 时结果相近但不完全吻合，原因是 2 个 未知量来拟合 13 个 cap，只能平均接近不能各个匹配。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-28c2c82df0287e2bcbc7110dfcc48f91_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;560&quot; data-rawheight=&quot;420&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-28c2c82df0287e2bcbc7110dfcc48f91&quot; data-watermark-src=&quot;v2-3f037e1d7057305de977bb234a420262&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;下图展示着当 为已设好的 0.01 和 ς(t) 为分段常数时，USD ATM cap 的 市场价格 (红圈) 和模型价格 (蓝线)，发现它们在不同 T 时完全吻合，原 因是当 已知，每个 cap 和 ς 是一一对应关系。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-46765c49338460f58fc9c194cb7b3cea_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;560&quot; data-rawheight=&quot;420&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-46765c49338460f58fc9c194cb7b3cea&quot; data-watermark-src=&quot;v2-67e0ce5becb27caa627b9b983a661961&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;下图展示着当 和 ς 为常数时，USD ATM coterminal swaption 的市场价 格 (红圈) 和模型价格 (蓝线)，发现它们在短期 T 时结果相近但长期 T 相 差很远。原因是 2 个未知量来拟合 11 个 cap，只能平均接近不能各个匹 配，而且后面几个 swaption 的到期日从 15 年到 30 年，常数参数很难能 把这么长的掉期期权拟合好。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-3bcd78b60f8d82021ff2b164e8637ec2_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;560&quot; data-rawheight=&quot;420&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-3bcd78b60f8d82021ff2b164e8637ec2&quot; data-watermark-src=&quot;v2-02630b7756dae9a5f6075e90a3581814&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;下图展示着当 为常数和 ς( ) 为分段常数时，USD ATM coterminal swaption 的市场价格 (红圈) 和模型价格 (蓝线)，发现它们在不同 T 时完 全吻合，原因是当 先校正好，每个 swaption 和 ς 是一一对应关系。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-386339a35bc5ffc2d9c85e2a3f84bb81_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;560&quot; data-rawheight=&quot;420&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-386339a35bc5ffc2d9c85e2a3f84bb81&quot; data-watermark-src=&quot;v2-1cb72648327911c1d9cddcfeded8e342&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;商品类&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;3.1 Schwartz 模型&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;模型介绍&lt;/b&gt;&lt;/p&gt;&lt;p&gt;股权类的 Black-Scholes 模型也适用于商品类，但是它无法处理具有均值 回归 (mean-reverting) 特征的商品。为解决上述缺点，一个方法就是将均 值回归特征融合到商品价格过程中，而 Schwartz 模型涵盖这些特点。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;商品类的 Schwartz (SW) 模型下的 SDE 是描述商品即期价格 (commodity spot price) 的走势:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-49a0c5231f70799e27d02e52be688e75_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;53&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;其中&lt;/p&gt;&lt;ul&gt;&lt;li&gt;r(t) = 短期利率&lt;/li&gt;&lt;li&gt;k(t)=C(t) 的均值回归速率 &lt;/li&gt;&lt;li&gt;ς(t)=C(t) 的均值&lt;/li&gt;&lt;li&gt;6(t)=C(t) 的波动率&lt;/li&gt;&lt;li&gt;B(t) = 布朗运动&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;该模型是 Eduardo S. Schwartz 在 1997 年提出，其论文题目是&lt;/p&gt;&lt;p&gt;&lt;i&gt;The Stochastic Behavior of Commodity Prices Implications for Valuation and Hedging&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;模型参数&lt;/b&gt;&lt;/p&gt;&lt;p&gt;一般情况下&lt;/p&gt;&lt;ul&gt;&lt;li&gt; r(t) 当成常数&lt;/li&gt;&lt;li&gt;6 (t)和k(t)当成常数 &lt;/li&gt;&lt;li&gt;ς(t)当成分段常数&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;它们的获取方式为&lt;/p&gt;&lt;ul&gt;&lt;li&gt;r：根据商品结算的货币，绝大部分情况是 USD，用其掉期曲线 USD Libor 3M 曲线，在曲线上插出 T 点的 r 值&lt;/li&gt;&lt;li&gt;k和6：从一系列商品期货欧式期权中校正出来 &lt;/li&gt;&lt;li&gt;ς(t) :从商品期货曲线中校正出来&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;3.2 市场标准产品和数据&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;产品定义&lt;/b&gt;&lt;/p&gt;&lt;p&gt;商品类市场标准产品是一系列“不同行权价格 K 和不同年限 T 商品欧式期货期权 (CM futures option)”，定义如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;定义:期权买方和卖方进入商品欧式期货期权 (commodity futures option) 合约的将同意以下内容:&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 期权买方付出期权金 (premium) 便有权利 (right)去行使，而卖方 收取期权金后则有义务 (obligation) 履行买方行使权利的义务。&lt;/li&gt;&lt;li&gt; 看涨期权:买方有权在到期日以 K 买入期货，而卖方一旦被行使期 权时，则有责任以 K 卖出期货&lt;/li&gt;&lt;li&gt; 看跌期权:买方有权在到期日以 K 卖出期货，而卖方一旦被行使期 权时，则有责任以 K 买入期货&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;其中 K 是执行价格 (strike price)。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;市场数据&lt;/b&gt;&lt;/p&gt;&lt;p&gt;某天的咖啡期货期权和期货价格的真实数据如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-71ff88d7da586e27f399d5fa2cd443fb_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;207&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-71ff88d7da586e27f399d5fa2cd443fb&quot; data-watermark-src=&quot;v2-90d274c5dc1c6348266fb3b910381012&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;上图数据又称 CM futures option 波动率平面，它是二维数据结构&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 行对应的年限 (expiry)，期权年限从 1 个月到 2 年&lt;/li&gt;&lt;li&gt; 行对应的行权价格 (strike)，注意第四行白色粗体 302.85 是 ATM&lt;/li&gt;&lt;li&gt; 行权价格，其对应的绿色粗体是 ATM 波动率&lt;/li&gt;&lt;li&gt; 波动率单位是%，32.33 实际上指的是 32.33%&lt;/li&gt;&lt;li&gt; 市场波动率带进 Black 公式得到期货期权的市场价格&lt;br&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-b1dd0655221abecf909cd64938a76466_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;269&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-b1dd0655221abecf909cd64938a76466&quot; data-watermark-src=&quot;v2-1af8b3eef51969b7b7e225d6afd79854&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;上图数据又称 CM futures 价格曲线，它是一维数据结构，每一个年限对 应一个期货价格。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;3.3 市场价格和模型价格&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;市场价格&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-d642cd51b43f28e4dd5ab41f58afc2e1_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;198&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-d642cd51b43f28e4dd5ab41f58afc2e1&quot; data-watermark-src=&quot;v2-aa56197ae63a2da515172503df699ee9&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;CM futures option 的市场价格是之后模型校正的基准 (benchmark)。关于 Black 模型的 CM futures option 推导细节，可以参考 &lt;i&gt;Commodities and&lt;/i&gt; &lt;i&gt;Commodity Derivatives Modeling and Pricing for Agriculturals, Metals and Energy, Chapter 4.&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;模型价格&lt;/b&gt;&lt;/p&gt;&lt;p&gt;给定k和6，通过 Ito&#39;s&#39;lemma 可以推出F(0,T)在 SW 模型下的表达式以及它的 SDE:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-915ea72e3c12b907cec2b1fdd0a99564_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;115&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-915ea72e3c12b907cec2b1fdd0a99564&quot; data-watermark-src=&quot;v2-9134c5f3fa3bc7dd8b1e090b11ad3ee0&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;从上面的 SDE 发现参数 ( ) 不见了，而且在 SW 模型下 FSW(0,T) 的分布 和 Black 模型下的分布非常相似，不同的只是离散项。因此，套用 Black 模型的公式，类比出 CM futures option 的定价公式:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-a8825149731e5852cd7865699b7bd531_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;265&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-a8825149731e5852cd7865699b7bd531&quot; data-watermark-src=&quot;v2-97fe2d96f2374e22140a9e47244d0617&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;3.4 模型校正&lt;/b&gt;&lt;/p&gt;&lt;p&gt;SW 模型校正步骤总结如下:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;先假设FSW(0,Ti)=F(0,Ti),从一系列欧式期货期权校正出和&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;    2. 再使得FSW(0,Ti)=F(0,Ti),从期货曲线进行校正出(t)&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;步骤 1&lt;/p&gt;&lt;p&gt;SW 模型校正本质上是找到“最优” 和 ς，从而最小化一系列 ATM CM futures option 的市场价格和模型价格之间的差异，其目标函数为:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-a14a59b836fed4deecfb184d4c8160dd_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;80&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;#SF 模型校正步骤 1 代码
MP = fminsearch(@(x) option_diff( F_mkt, K, r, 0, x, T1, OptFlavor, vol_mkt), [0.1;0.1] ); 
function diff = option_diff( F, K, r, b, x, T, Flavor, vol_mkt )

kappa = x(1); sigma = x(2);

vol_mdl = sigma .* sqrt( (1-exp(-2*kappa.*T))./(2*kappa.*T) );
opt_mdl = OPTION_BLACK( Flavor, F, K, T, r, b, vol_mdl ); 
opt_mkt = OPTION_BLACK( Flavor, F, K, T, r, b, vol_mkt );

diff = sum( (opt_mdl - opt_mkt).^2 );
end&lt;/code&gt;&lt;p&gt;步骤 2&lt;/p&gt;&lt;p&gt;在 SW 模型下定价 CM futures option 时不需要 ，因为 F 是从期货曲线中 提取的。在确定了6和k 之后，再校正 (t) 从而完全匹配期货的市场价格 和模型价格，其目标函数为:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-aab1006ff98b2f5ddf4f9abe44bd0391_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;86&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;其中&lt;/p&gt;&lt;p&gt;Fmkt(0, Ti) = 从期货曲线插出 Ti 时点的期货价格 &lt;/p&gt;&lt;p&gt;FSW(0, Ti; ) = SW 模型计算的 Ti 时点的期货价格&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-a13b30aee7f51f5ad38c40e19b1d9127_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;372&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-a13b30aee7f51f5ad38c40e19b1d9127&quot; data-watermark-src=&quot;v2-edf0edd18d403287d2f409ecf3504d47&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;#SF 模型校正步骤 2 代码
theta = Calibration_F( MP, SRspline, C, F_mkt, T );

function theta = Calibration_F( x, SRspline, C, F, T )
kappa = x(1); sigma = x(2);
temp = integration( SRspline, kappa, T );
RHS = exp(-kappa*T).*log(C)-log(F)+temp-0.5*sigma^2/kappa.*(1-exp(-kappa*T)) + 0.25*sigma^2/kappa*(1-exp(-2*kappa*T)); LHS = (1-exp(-kappa*T)) / kappa;

theta = RHS ./ LHS;
end&lt;/code&gt;&lt;p&gt;&lt;b&gt;3.5 季节性调整&lt;/b&gt;&lt;/p&gt;&lt;p&gt;与典型的投资性资产相比，农产品的价格通常显示出季节性特征。在旺季 时，农产品的产量会剧增而导致价格下降。之后，农产品价格通常会逐渐 上涨，当然这也取决农产品不可预见的存储量。因此，在对农产品价格进 行建模时会考虑季节性因素。对那些长期期权进行定价时，季节性因素显 得更为重要。&lt;/p&gt;&lt;p&gt;为了在商品价格过程中体现季节性因素的影响，通常会用一个函数来对 “季节性的贡献”进行建模。说明如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-4b5270404652a27577fa7fe3d0d64a50_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;168&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-4b5270404652a27577fa7fe3d0d64a50&quot; data-watermark-src=&quot;v2-1d7bebc610484db78aa27cdc3f5f3bb7&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;带季节性调整的 SW 模型校正步骤总结如下:&lt;/p&gt;&lt;p&gt;1. 用KalmanFilter和m个期货校正季节性函数的β和ψ&lt;/p&gt;&lt;p&gt;2. 最小化一系列欧式期货期权的市场价格和模型价格得出和&lt;/p&gt;&lt;p&gt;3. 最小化一系列期货曲线的市场价格和模型价格得出(t)&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;上述步骤 2 和 3 和不带季节性调整的 SW 模型步骤 1 和 2 一样 (见小节 3.4)，不同的是期权公式里面的 FSW(0,T)要做季节性调整。&lt;/p&gt;&lt;p&gt;因此在上面校正过程之前，我们必须知道季节函数 f 里面的参数 β 和 ψ， 而校正它们用的是 Kalman Filter (KF)方法。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;3.6 Kalman Filter 方法&lt;/b&gt;&lt;/p&gt;&lt;p&gt;为了节省空间，将时间 t 写成下标，比如 S(t)写成 St，F(t, T) 写成 Ft,T，定义&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;xt = lnSt = 现货价格的对数&lt;/p&gt;&lt;p&gt;yt = lnFt,T + fT = 经过季节因素调整后的期货价格的对数 &lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;根据以上符号和 SW 模型可推出以下两个线性方程:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-210e2874902599c57d47a2a7464328c4_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;349&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-210e2874902599c57d47a2a7464328c4&quot; data-watermark-src=&quot;v2-13b5400461b9b8ddfadd455f77df9e16&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;上面两个方程:&lt;/p&gt;&lt;ul&gt;&lt;li&gt; E2 是一个观察方程，它将列向量 yt 和标量 xt，解释列向量 ct 和误差列向量 et 联系起来。&lt;/li&gt;&lt;li&gt;E1 是一个动态方程，它描述一个一阶马可夫链 (Markov chain) 过 程。变量 Tt, Rt, Qt, Zt 和 Ht 称为系统变量，它们是关于 SW 模型参数的函数。&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;在 KF 校正过程中需要不同期限期货的历史价格，如下图所示&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-0d4465287370b9487f0f9fc4a0ffc6ae_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;281&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-0d4465287370b9487f0f9fc4a0ffc6ae&quot; data-watermark-src=&quot;v2-9e42c09c88680300ead7a1edc9cfb7c1&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;每行代表不同天数上的期货价格 (每隔 7 天)&lt;/li&gt;&lt;li&gt; 每列代表不同期限的期货价格 (1 个月、3 个月到 15 个月)&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;KF 方法是在已知数据 Yt = {y1, y2 ... yt} 和相关模型的情况下，更新 xt+1 条 件分布。因为条件分布是一个正态分布过程，用条件均值和协方差矩阵就 足以说明此过程。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;将 xj|i 和 Σ j|i 定义在已知 Yi 的情况下 xj 的条件均值和协方差矩阵，我们有 xj|Yi~N(xj|i Σj|i)&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;做好准备工作&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 算出起始值 x1|0 和 Σ1|0&lt;/li&gt;&lt;/ul&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-262b6f0ead53507b61b1dfd8bd3ba163_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;28&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 初始化对数密度概率函数 p = 0&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;KF 算法描述如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-13980ba58165f4a49a12d4b7c1c29d9e_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;544&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-13980ba58165f4a49a12d4b7c1c29d9e&quot; data-watermark-src=&quot;v2-6c197de760b1527f12c9602e0b71375a&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;最后最大化 p 来得到 β* ψ* ς* * μ* H*。关于以上 Kalman Filter 校正步 骤，可以参考&lt;i&gt;Analysis of Financial Time Series, Chapter 11.&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-2e1cf2e9f3606e5de1c0c2c59be6e475_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;652&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-2e1cf2e9f3606e5de1c0c2c59be6e475&quot; data-watermark-src=&quot;v2-6e0a5753fc595de453d0d4a13d149891&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;外汇类&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;4.1 Heston 模型&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;模型介绍&lt;/b&gt;&lt;/p&gt;&lt;p&gt;虽然 Black-Scholes 模型在市场上被广泛应用于定价欧式期权，该模型假 设波动性是常数或是时间 t 的函数。从实证证据可以看出，这一假设是错 的，资产的波动率也表现出随机性，就像资产价格一样。而 Heston 模型 在 Black-Scholes 模型基础上把波动率看成是个随机变量。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;股权类的 Heston 模型下的 2 个 SDE 分别描述即期汇率 (spot FX rate) 和 其波动率 (volatility) 的走势:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-d14944d03889d5dfc39dd2f7a9029e42_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;284&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-d14944d03889d5dfc39dd2f7a9029e42&quot; data-watermark-src=&quot;v2-5584bb6d1e13c4944a1de6baf8af412f&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;该模型是 Steven L. Heston 在 1993 年提出，其论文题目是&lt;/p&gt;&lt;p&gt;&lt;i&gt;A Closed-Form Solution for Options with Stochastic Volatility with Applications to Bond and Currency Options&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;模型参数&lt;/b&gt;&lt;/p&gt;&lt;p&gt;一般情况下&lt;/p&gt;&lt;ul&gt;&lt;li&gt; rd(t) 和 rf(t) 当成常数  &lt;/li&gt;&lt;li&gt;v0 当成常数&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;它们的获取方式为&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-7a517c73bacf86bdc90f3e9622cbd68b_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;94&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;4.2 市场标准产品和数据&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;产品定义&lt;/b&gt;&lt;/p&gt;&lt;p&gt;外汇类市场标准产品是一系列“不同 Delta 和不同年限 T 外汇欧式期权 (FX option)”，定义如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;用 FOR 代表外币，DOM 代表本币，FOR/DOM 为货币对。 期权买方和卖 方进入外汇欧式期权 (FX vanilla option) 合约的将同意以下内容:&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 买方付出期权金 (premium) 便有权利 (right)去行使，而卖方收取 期权金后则有义务 (obligation) 履行买方行使权利的义务。&lt;/li&gt;&lt;li&gt; 看涨 FOR/DOM 期权 (看涨外币看跌本币): 买方有权在到期日进入 当前即期市场买入外币 N，并卖出本币 N×K;而卖方一旦被行使期 权时，则有责任卖出外币 N，并买入本币 N×K&lt;/li&gt;&lt;li&gt; 看跌 FOR/DOM 期权 (看跌外币看涨本币): 买方有权在到期日进入 当前即期市场卖出外币 N，并买入本币 N×K ;而卖方一旦被行使 期权时，则有责任买入外币 N，并卖出本币 N×K&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;其中 N 是名义金额 (notional)，K 是执行汇率 (strike rate)。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;市场数据&lt;/b&gt;&lt;/p&gt;&lt;p&gt;某天的 EURUSD 期权的真实数据如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-e65862fab60181dc3edda4d73f859d4f_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;230&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-e65862fab60181dc3edda4d73f859d4f&quot; data-watermark-src=&quot;v2-73cc59acbb049b4c40f273fc3ac7f312&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;上图数据又称 FX option 波动率平面，它是二维数据结构&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 行对应的年限 (expiry)，期权年限从 1 天到 2 年&lt;/li&gt;&lt;li&gt; 行对应的报价惯例 (convention)，外汇市场最常见的报价类型是价中(ATM)，25 和 10 风险反转 (risk reversal, RR) 组合，25 和 10 蝶式 (butterfly, BF) 组合&lt;/li&gt;&lt;li&gt; 波动率单位是%，6.44 实际上指的是 6.44%&lt;/li&gt;&lt;li&gt;市场波动率带进 BS 公式得到期权的市场价格&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;下表根据 ATM, RR 和 BF 之间波动率的联系推出 10 和 25 delta 对应的波动率:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-589fb1724376d6c2014300ff6b485084_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;199&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-589fb1724376d6c2014300ff6b485084&quot; data-watermark-src=&quot;v2-8d3cee0aa6ea1b9a5a4bda9caaedc128&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;利用上表右边的公式算出各个 delta 和 T 下的波动率。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-fae05b3dfddf066d2a614d46405dda97_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;372&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-fae05b3dfddf066d2a614d46405dda97&quot; data-watermark-src=&quot;v2-d67d90767407be6829585932b389644f&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;4.3 市场价格和模型价格&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;市场价格&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-4dc75ee35df3d6c1bcc931fe6abd5eab_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;211&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-4dc75ee35df3d6c1bcc931fe6abd5eab&quot; data-watermark-src=&quot;v2-d361658b1dbe9eb24840993fb03b3468&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;FX option 的市场价格是之后模型校正的基准 (benchmark)。关于 BS 模型 的 FX option 公式推导细节，可参考 &lt;i&gt;Foreign Exchange Option Pricing - A Practitioner&#39;s Guide, Chapter 2.&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;模型价格&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-e602ffc7f26812d3f85da357cb116b1c_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;516&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-e602ffc7f26812d3f85da357cb116b1c&quot; data-watermark-src=&quot;v2-bc0ef11883e2bd8ad63d0602366b0cca&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;当模型参数为常数时，关于 Heston 模型的 option 推导细节，可以参考 &lt;i&gt;The Heston Model and Its Extensions in Matlab and C#, Chapter 1.&lt;/i&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;当参数为分段常数时，表达如下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-8e0f08f2bca0614cbcbda63e4d158941_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;110&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-8e0f08f2bca0614cbcbda63e4d158941&quot; data-watermark-src=&quot;v2-69272942863ff3d2c318a696ad75325a&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;为了简化公式，用 Wk 代表 Heston 模型参数集，即&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-654125d6eb2bb96a5958d68a1e89bef9_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;36&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-d9b85912332f6fa634e220b11f07f0fe_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;690&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-d9b85912332f6fa634e220b11f07f0fe&quot; data-watermark-src=&quot;v2-7069bdf57d94e571622378c101394649&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;当模型参数为分段常数时，关于 Heston 模型的 option 推导细节，可以参考 &lt;i&gt;The Heston Model and Its Extensions in Matlab and C#, Chapter 9.&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;上面公式难点就是如何用迭代的方法求得 C 和 D，最后计算出 P，代码如 下:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-b3c33c68744c5ea37dbf6784e7ab38b3_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;521&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-b3c33c68744c5ea37dbf6784e7ab38b3&quot; data-watermark-src=&quot;v2-d9eb616a678ae44c79e69bd90aa63979&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;4.4 模型校正&lt;/b&gt;&lt;/p&gt;&lt;p&gt;在外汇期权市场上，对每一个标准 delta 有 n 个到期的 option，到期日分别为&lt;/p&gt;&lt;p&gt;0 = T0 &amp;lt; T1 &amp;lt; ... &amp;lt; k &amp;lt; ... &amp;lt; n&lt;/p&gt;&lt;p&gt;而对于每一个 Tk，option 的行权汇率为 K1,k ... j,k ... m,k。 &lt;/p&gt;&lt;p&gt;接下来我们分别讨论当模型参数为常数和分段常数是的校正过程。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;常数型参数&lt;/b&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-c276df44faf0d052f083b28f9fa96074_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;614&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-c276df44faf0d052f083b28f9fa96074&quot; data-watermark-src=&quot;v2-1fc257913f0f12f0276daf2354a0a025&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;分段常数型参数&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-e3ae88afe441d44a5b19008595df2e0a_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;533&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-e3ae88afe441d44a5b19008595df2e0a&quot; data-watermark-src=&quot;v2-9bc7349231f9233561723539f01e7f93&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-095b155165259f43fc2a75fe27f740c1_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;483&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-095b155165259f43fc2a75fe27f740c1&quot; data-watermark-src=&quot;v2-e0e072c2bcbd999d1ff2476e5a09929f&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;4.5 校正结果&lt;/b&gt;&lt;/p&gt;&lt;p&gt;下图展示着 USDJPY option 的市场价格 (红圈) 和模型价格 (蓝线)，发现它们在不同 delta 和 T 时差别不大。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-b5241ae4155851826d510c3db8b9069d_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;560&quot; data-rawheight=&quot;420&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-b5241ae4155851826d510c3db8b9069d&quot; data-watermark-src=&quot;v2-0365125e202c8853127634ff3e1e2140&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;下图展示着模型参数的分段常数形式，发现它们都不是和时间 t 呈单调关 系，但除了 上下摇摆而变化很大之外，其他三个参数总体来讲还比较 稳定。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-a90a5a70831dcabf83c0066ca49f2962_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;560&quot; data-rawheight=&quot;420&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-a90a5a70831dcabf83c0066ca49f2962&quot; data-watermark-src=&quot;v2-252db598cf6908c897963438efe1e29c&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;总结&lt;/b&gt;&lt;/p&gt;&lt;p&gt;模型校正是选择模型中的参数使得市场流动性强的交易价格 (市场价格) 和模型输出 (模型价格) 完全匹配或尽可能接近。完全匹配价格意味着消 除套利机会。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;几乎所有的金融模型都有一些不能准确测量的参数。在最简单 Black- Scholes 模型，该参数是波动率。如果我们无法测量该参数，我们如何决 定波动率的值?如果决定不了，那么该模型是无用的。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;两种方式可以得到波动率的值。一个是使用历史数据，另一个是使用当天 的期权价格数据。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;历史波动率：它的主要问题是使用过去的数据向后看而未来无关。 另一个问题是，它可能给出一个和市场价格不一致的价格。例如你 有兴趣购买一个期权。 你根据历史波动率算出的价格是 10 美元， 然而该期权的市场价格是 19 美元。你还有兴趣购买吗? 这时候， 要不期权市价错了，要不你对波动率的估计的不正确。&lt;/li&gt;&lt;li&gt; 隐含波动率：它是隐含在市场交易产品的价格里面。在上面的例子 中，我们要问什么波动率放入 Black-Scholes 以获得 19 美元的“正 确”价格。然后使用该波动率来定价其他复杂产品。 这时我们是向 前看的，而不是用来自过去的信息。&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;在量化金融上，第二种叫做模型校正，第一种不是。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;模型校正使得市场流动性强的交易价格接近模型价格，但是这些产品的市 场价格已经有了，为何还需要模型价格呢?请注意，模型校正从来不是为 了定价那些有市价的简单产品，而且为了定价那些没有市价的复杂产品。 但是，一个模型连一个简单产品的价格都算不准，谁还会对它算准一个复 杂产品有信心呢?理清这个就知道模型校正的意义了。本文只是讲了模型 校正的基本知识，此外:&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 模型校正在实际应用上还会有许多变种，目标函数除了最小化绝对 价格，还有最小化相对价格或绝对波动率，它们各有优缺点限于篇 幅就不延伸了。&lt;br&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 模型校正和机器学习也有同异，相同之处是它们最终都是用“最小化代价函数技巧”来解决问题;不同之处是前者用数量少的当前数 据，而后者用数量多的历史数据。&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 模型校正也可以用于量化交易上，比如校正一个均值回归例如 Hull-White 模型加上 Kalman Filter 方法可以用于配对交易 (pairs trading)。&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt; 模型校正还有更有挑战的内容，比如 Libor Market+SABR 模型、 Local Stochastic Volatility 模型，这些内容是量化金融的巅峰。&lt;/li&gt;&lt;/ul&gt;</description>
<author>量化家</author>
<guid isPermaLink="false">2018-07-25-40528417</guid>
<pubDate>Wed, 25 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>算法||LSTM</title>
<link>https://henix.github.io/feeds/zhuanlan.c_106548378/2018-07-24-40449368.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/40449368&quot;&gt;原文&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;LSTM Networks是递归神经网络（RNNs）的一种，该算法由Sepp Hochreiter和Jurgen Schmidhuber在Neural Computation上首次公布。后经过人们的不断改进，LSTM的内部结构逐渐变得完善起来（图1）。在处理和预测时间序列相关的数据时会比一般的RNNs表现的更好。目前，LSTM Networks已经被广泛应用在机器人控制、文本识别及预测、语音识别、蛋白质同源检测等领域。基于LSTM Networks在这些方面的优异表现，本推文旨在探究LSTM是否可以应用于股票时间序列的预测。&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-40e8a6c2517c2d9f2324d0a2fdc9814b_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;622&quot; data-rawheight=&quot;412&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-40e8a6c2517c2d9f2324d0a2fdc9814b&quot; data-watermark-src=&quot;v2-b5f7fdb6f2245c6b7e91de03d93903a6&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;b&gt;LSTM Networks 建模流程&lt;/b&gt;&lt;/p&gt;&lt;h2&gt;&lt;b&gt;处理股票时间序列的流程&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;本推文使用的LSTM处理股票序列的流程如图2。构建LSTM模型使用库主要为Keras。&lt;/p&gt;&lt;p&gt;&lt;b&gt;数据获取与处理：&lt;/b&gt;对于时间序列，我们通常会以[X(t-n),X(t-n+1),…,X(t-1),X(t)]这n个时刻的数据作为输入来预测(t+1)时刻的输出。对于股票来说，在t时刻会有若干个features，因此，为了丰富features以使模型更加精确，本推文将n(time series)×s(features per time series)的二维向量作为输入。LSTM对于数据标准化的要求很高，因此本推文所有input数据均经过z-score标准化处理。&lt;/p&gt;&lt;p&gt;&lt;b&gt;LSTM模型构建：&lt;/b&gt;作为循环层的一种神经网络结构，只使用LSTM并不能构建出一个完整的模型，LSTM还需要与其他神经网络层（如Dense层、卷积层等）配合使用。此外，还可以构建多层LSTM层来增加模型的复杂性。&lt;/p&gt;&lt;p&gt;&lt;b&gt;回测：&lt;/b&gt;本推文进行的回测分为两种，一是直接将LSTM输出结果作为做单信号在个股上进行回测，二是将LSTM的预测结果作为一种择时信号，再配合其他选股模型（如BigQuant平台的StockRanker）进行回测。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-49b808f7911ab3dee7dae7491b18bcf3_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;196&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-49b808f7911ab3dee7dae7491b18bcf3&quot; data-watermark-src=&quot;v2-6bbf089b1ab53b41c8625bcc4af35b7c&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;b&gt;LSTM对沪深300未来五日收益率预测&lt;/b&gt;&lt;/p&gt;&lt;p&gt;综合以上两点，本推文所使用的输入和输出为利用过去30天的数据预测将来五天的收益。&lt;/p&gt;&lt;p&gt;测试对象：沪深300&lt;/p&gt;&lt;p&gt;数据选择和处理：&lt;/p&gt;&lt;ul&gt;&lt;li&gt;input的时间跨度为30天，每天的features为[&#39;close&#39;,&#39;open&#39;,&#39;high&#39;,&#39;low&#39;,&#39;amount&#39;,&#39;volume&#39;]共6个，因此每个input为30×6的二维向量。&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;output为未来5日收益future_return_5（future_return_5&amp;gt;0.2,取0.2;future_return_5&amp;lt;-0.2,取-0.2)，为使训练效果更加明显，output=future_return_5×10； features均经过标准化处理(在每个样本内每个feature标准化处理一次)。&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;训练数据：沪深300 2005-01-01至2014-12-31时间段的数据；测试数据：沪深300 2015-01-01至2017-05-01时间段数据。&lt;br&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;模型构建：鉴于数据较少（训练数据约2500个，预测数据约500个），因此模型构建的相对简单。模型共四层，为一层LSTM层+三层Dense层（图3）。&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;回测：得到LSTM预测结果后，若LSTM预测值小于0，则记为-1，若大于0，记为1。&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;部分代码：&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;# 数据处理：设定每个input（30time series×6features）以及数据标准化
train_input = []
train_output = []
test_input = []
test_output = []
for i in range(conf.seq_len-1, len(traindata)):
    a = scale(scaledata[i+1-conf.seq_len:i+1])
    train_input.append(a)
    c = data[&#39;return&#39;][i]
    train_output.append(c)
for j in range(len(traindata), len(data)):
    b = scale(scaledata[j+1-conf.seq_len:j+1])
    test_input.append(b)
    c = data[&#39;return&#39;][j]
    test_output.append(c)

# LSTM接受数组类型的输入
train_x = np.array(train_input)
train_y = np.array(train_output)
test_x = np.array(test_input) 
test_y = np.array(test_output)
# 自定义激活函数
import tensorflow as tf
def atan(x): 
    return tf.atan(x)

# 构建神经网络层 1层LSTM层+3层Dense层
# 用于1个输入情况
lstm_input = Input(shape=(30,6), name=&#39;lstm_input&#39;)
lstm_output = LSTM(128, activation=atan, dropout_W=0.2, dropout_U=0.1)(lstm_input)
Dense_output_1 = Dense(64, activation=&#39;linear&#39;)(lstm_output)
Dense_output_2 = Dense(16, activation=&#39;linear&#39;)(Dense_output_1)
predictions = Dense(1, activation=atan)(Dense_output_2)

model = Model(input=lstm_input, output=predictions)

model.compile(optimizer=&#39;adam&#39;, loss=&#39;mse&#39;, metrics=[&#39;mse&#39;])

model.fit(train_x, train_y, batch_size=conf.batch, nb_epoch=10, verbose=2)

# 预测
predictions = model.predict(test_x)

# 预测值和真实值的关系
data1 = test_y
data2 = predictions
fig, ax = plt.subplots(figsize=(8, 6))
ax.plot(data2,data1, &#39;o&#39;, label=&quot;data&quot;)
ax.legend(loc=&#39;best&#39;)&lt;/code&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-fba00d7cf1300546eff924d31bbe5dc7_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;495&quot; data-rawheight=&quot;361&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-fba00d7cf1300546eff924d31bbe5dc7&quot; data-watermark-src=&quot;v2-546896e11fffb7b6590b73b8d2668a6d&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;# 如果预测值&amp;gt;0,取为1；如果预测值&amp;lt;=0,取为-1.为回测做准备
for i in range(len(predictions)):    
    if predictions[i]&amp;gt;0:
        predictions[i]=1    elif predictions[i]&amp;lt;=0:
        predictions[i]=-1

# 将预测值与时间整合作为回测数据
cc = np.reshape(predictions,len(predictions), 1)
databacktest = pd.DataFrame()
databacktest[&#39;date&#39;] = datatime
databacktest[&#39;direction&#39;]=np.round(cc)&lt;/code&gt;&lt;p&gt;每个模型做两次回测，第一次回测（后文简称回测1）为直接以LSTM预测值在沪深300上做单：若LSTM预测值为1，买入并持有5day（若之前已持仓，则更新持有天数），若LSTM预测值为-1，若为空仓期，则继续空仓，若已持有股票，则不更新持有天数；&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;第二次回测（后文简称回测2）为以LSTM为择时指标，与StockRanker结合在3000只股票做单：若LSTM预测值为1，则允许StockRanker根据其排序分数买入股票，若LSTM预测值为-1，若为空仓期，则继续空仓，若已持有股票，则禁止StockRanker买入股票，根据现有股票的买入时间，5天内清仓；&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-b1e30f42a79e874c0bc3b2d1a395035f_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;136&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-b1e30f42a79e874c0bc3b2d1a395035f&quot; data-watermark-src=&quot;v2-78e81f4dd1c057e0a56c0d4d160d6ee1&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;b&gt;1)future_return_5是否二极化处理比较&lt;/b&gt;&lt;/p&gt;&lt;p&gt;对于future_return_5的处理分为两种情况，一种为直接将future_return_5作为output进行模型训练，二是将future_return_5二极化（future_return_5&amp;gt;0,取1；future_return_5&amp;lt;=0,取-1），然后将二极化后的数据作为output进行模型训练。&lt;/p&gt;&lt;p&gt;两种处理方法的回测情况如图4，图5。由于模型每次初始化权重不一样，每次预测和回测结果会有一些差别，但经过多次回测统计，直接将future_return_5作为output进行模型训练是一个更好的选择。在本推文接下来的讨论中，将会直接将future_return_5作为output进行模型训练。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-03bdabfee8f59a75e6eda470baeb893d_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;468&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-03bdabfee8f59a75e6eda470baeb893d&quot; data-watermark-src=&quot;v2-2fadda2fb35a9479a343c43dda2bb81c&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-2ee3e51fe1ab0a31f5564506a9cbb7ec_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;474&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-2ee3e51fe1ab0a31f5564506a9cbb7ec&quot; data-watermark-src=&quot;v2-dbe6b9707d8cfe131f5adb6cb63350d7&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h2&gt;&lt;b&gt;2)在权重上施加正则项探究&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;神经网络的过拟合：在训练神经网络过程中，“过拟合”是一项尽量要避免的事。神经网络“死记”训练数据。过拟合意味着模型在训练数据的表现会很好，但对于训练以外的预测则效果很差。原因通常为模型“死记”训练数据及其噪声，从而导致模型过于复杂。本推文使用的沪深300的数据量不是太多，因此防止模型过拟合就尤为重要。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;训练LSTM模型时，在参数层面上有两个十分重要的参数可以控制模型的过拟合：Dropout参数和在权重上施加正则项。Dropout是指在每次输入时随机丢弃一些features，从而提高模型的鲁棒性。它的出发点是通过不停去改变网络的结构，使神经网络记住的不是训练数据本身，而是能学出一些规律性的东西。正则项则是通过在计算损失函数时增加一项L2范数，使一些权重的值趋近于0，避免模型对每个feature强行适应与拟合，从而提高鲁棒性，也有因子选择的效果；在1)的模型训练中，我们加入了Dropout参数来避免过拟合。接下来我们尝试额外在权重上施加正则项来测试模型的表现。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;回测结果如图6，加入正则项之后回测1和回测2的最大回撤均有下降，说明加入正则项后确实减轻了模型的过拟合。比较加入正则项前后回测1的持仓情况，可以看到加入正则化后空仓期更长,做单次数减少(19/17)，可以理解为：加入正则项之后，模型会变得更加保守。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;正则项的问题：经过试验,对于一个LSTM模型来说，正则项的参数十分重要，调参也需要长时间尝试，不合适的参数选择会造成模型的预测值偏正分布(大部分预测值大于0)或偏负分布，从而导致预测结果不准确，而较好的正则参数会使模型泛化性非常好(图6所用参数训练出来的模型的预测值属于轻度偏正分布)。本文之后的讨论仍会基于未加权重正则项的LSTM模型。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-33156ad39591613a03c2f4001326ae99_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;473&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-33156ad39591613a03c2f4001326ae99&quot; data-watermark-src=&quot;v2-5310c6835ceeb0f0c32e6804f2fc2c41&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h2&gt;&lt;b&gt;3)双输入模型探究&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;除了传统的Sequential Model(一输入，一输出)外，本推文还尝试构建了Functional Model(支持多输入，多输出)。前面提到的features处理方法丢失了一项重要的信息：价格的高低。相同的input处在3000点和6000点时的future_return_5可能有很大不同。因此，本文尝试构建了&quot;二输入一输出&quot;的Functional Model：标准化后的features作为input输入LSTM，LSTM层的输出结果和一个指标-label(label=np.round(close/500))作为input输入后面的Dense层，最终输出仍为future_return_5(图7)。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-1960872c7a2a2199ea4a906552f861f8_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;177&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-1960872c7a2a2199ea4a906552f861f8&quot; data-watermark-src=&quot;v2-d3ec043369162e1ff233548b5d6a6720&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;部分代码：&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;# LSTM与stockranker配合回测
class conf:    start_date = &#39;2010-01-01&#39;    end_date=&#39;2017-05-01&#39;    # split_date 之前的数据用于训练，之后的数据用作效果评估    split_date = &#39;2015-01-01&#39;    instruments = D.instruments(start_date, end_date)    
    label_expr = [&#39;return * 100&#39;, &#39;where(label &amp;gt; {0}, {0}, where(label &amp;lt; -{0}, -{0}, label)) + {0}&#39;.format(20)]    # 持有天数，用于计算label_expr中的return值(收益)    hold_days = 5
    # 特征    features = [&#39;close_5/close_0&#39;,  # 5日收益    &#39;close_10/close_0&#39;,  # 10日收益    &#39;close_20/close_0&#39;,  # 20日收益    &#39;avg_amount_0/avg_amount_5&#39;,  # 当日/5日平均交易额    &#39;avg_amount_5/avg_amount_20&#39;,  # 5日/20日平均交易额    &#39;rank_avg_amount_0/rank_avg_amount_5&#39;,  # 当日/5日平均交易额排名    &#39;rank_avg_amount_5/rank_avg_amount_10&#39;,  # 5日/10日平均交易额排名    &#39;rank_return_0&#39;,  # 当日收益    &#39;rank_return_5&#39;,  # 5日收益    &#39;rank_return_10&#39;,  # 10日收益    &#39;rank_return_0/rank_return_5&#39;,  # 当日/5日收益排名    &#39;rank_return_5/rank_return_10&#39;,  # 5日/10日收益排名    &#39;pe_ttm_0&#39;,  # 市盈率TTM    ]
# 给数据做标注：给每一行数据（样本）打分，一般分数越高表示越好
m1 = M.fast_auto_labeler.v5(
    instruments=conf.instruments, start_date=conf.start_date, end_date=conf.end_date,
    label_expr=conf.label_expr, hold_days=conf.hold_days,
    benchmark=&#39;000300.SHA&#39;, sell_at=&#39;open&#39;, buy_at=&#39;open&#39;
)

# 计算特征数据
m2 = M.general_feature_extractor.v5(
    instruments=conf.instruments, start_date=conf.start_date, end_date=conf.end_date,
    features=conf.features)

# 数据预处理：缺失数据处理，数据规范化，T.get_stock_ranker_default_transforms为StockRanker模型做数据预处理
m3 = M.transform.v2(
    data=m2.data, transforms=T.get_stock_ranker_default_transforms(),
    drop_null=True, astype=&#39;int32&#39;, except_columns=[&#39;date&#39;, &#39;instrument&#39;],
    clip_lower=0, clip_upper=200000000)

# 合并标注和特征数据
m4 = M.join.v2(data1=m1.data, data2=m3.data, on=[&#39;date&#39;, &#39;instrument&#39;], sort=True)

# 训练数据集
m5_training = M.filter.v2(data=m4.data, expr=&#39;date &amp;lt; &quot;%s&quot;&#39; % conf.split_date)

# 评估数据集
m5_evaluation = M.filter.v2(data=m4.data, expr=&#39;&quot;%s&quot; &amp;lt;= date&#39; % conf.split_date)

# StockRanker机器学习训练
m6 = M.stock_ranker_train.v2(training_ds=m5_training.data, features=conf.features)

# 对评估集做预测
m7 = M.stock_ranker_predict.v2(model_id=m6.model_id, data=m5_evaluation.data)

# 生成卖出订单：hold_days天之后才开始卖出；对持仓的股票，按StockRanker预测的排序末位淘汰
if databacktest[&#39;direction&#39;].values[databacktest.date==current_dt]==-1: # LSTM择时卖    instruments = list(reversed(list(ranker_prediction.instrument[ranker_prediction.instrument.apply(lambda x: x in equities and not context.has_unfinished_sell_order(equities[x]))])))        
     for instrument in instruments:            
         if context.trading_calendar.session_distance(pd.Timestamp(context.date[instrument]), pd.Timestamp(current_dt))&amp;gt;=5:
                context.order_target(context.symbol(instrument), 0)if not is_staging and cash_for_sell &amp;gt; 0:
    instruments = list(reversed(list(ranker_prediction.instrument[ranker_prediction.instrument.apply(lambda x: x in equities and not context.has_unfinished_sell_order(equities[x]))])))        
    # print(&#39;rank order for sell %s&#39; % instruments)    for instrument in instruments:
        context.order_target(context.symbol(instrument), 0)
        cash_for_sell -= positions[instrument]            
        if cash_for_sell &amp;lt;= 0:                
            break
            
# 生成买入订单：按StockRanker预测的排序，买入前面的stock_count只股票
if databacktest[&#39;direction&#39;].values[databacktest.date==current_dt]==1: # LSTM择时买    buy_dt = data.current_dt.strftime(&#39;%Y-%m-%d&#39;)
    context.date=buy_dt
    buy_cash_weights = context.stock_weights
    buy_instruments = list(ranker_prediction.instrument[:len(buy_cash_weights)])
    max_cash_per_instrument = context.portfolio.portfolio_value * context.max_cash_per_instrument        
    for i, instrument in enumerate(buy_instruments):
        cash = cash_for_buy * buy_cash_weights[i]            
        if cash &amp;gt; max_cash_per_instrument - positions.get(instrument, 0): # 确保股票持仓量不会超过每次股票最大的占用资金量            cash = max_cash_per_instrument - positions.get(instrument, 0)            
        if cash &amp;gt; 0:
            context.order_value(context.symbol(instrument), cash)
            buy_dates[instrument] = current_dt

context.date = buy_dates&lt;/code&gt;&lt;p&gt;回测结果如图8。由回测结果可以看出，加入指示标后的LSTM模型收益率相对下降，但是回撤更小。LSTM预测值小于0的时间段覆盖了沪深300上大多数大幅下跌的时间段,虽然也错误地将一些震荡或上涨趋势划归为下跌趋势。或许这是不可避免的，俗话说高风险高回报，风险低那么回报也不会非常高，高回报和低风险往往不可兼得。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-3b68f728634de83ee3dd394e8de8e1a1_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;472&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-3b68f728634de83ee3dd394e8de8e1a1&quot; data-watermark-src=&quot;v2-49198b1d13b4b81b1149699dc27afb39&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;结论与展望&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;结论：&lt;/b&gt;本推文通过探究性地应用LSTM对沪深300未来五日收益率进行预测，初步说明了LSTM Networks是可以用在股票市场上的。由于LSTM更适用于处理个股/指数，因此，将LSTM作为择时模型与其他选股模型配合使用效果较好。利用LSTM模型对沪深300数据进行预测并将结果作为择时信号，可以显著改善stockranker选股模型在回测阶段的回撤。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;展望：&lt;/b&gt;由于个股数据量较少，LSTM模型的可扩展程度和复杂度受到很大制约，features的选择也受到限制（若input的features太多，而data较少的话，会使一部分features不能发挥出应有的作用，也极易造成过拟合）。将来我们希望能在个股/指数的小时或分钟数据上测试LSTM的性能。另外，将探究LSTM模型能否将属于一个行业的所有股票data一起处理也是一个可选的方向。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;说明：&lt;/b&gt;由于每次训练LSTM模型权重更新情况不同以及Dropout的随机性，LSTM模型的每次训练训练结果都会有差异。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;提示：&lt;/b&gt;由于LSTM涉及参数众多，目前还不能保证LSTM模型的稳定性，本推文所附回测结果均为多次训练模型后选取的较为理想的情况，目的是说明LSTM是可以应用于股票市场的以及将其作为择时模型是可能的。本推文所述以及提供的代码仅供探究及讨论，若要形成一个在股票市场比较实用的LSTM模型，还需要在features选择、模型构建、模型参数选择以及调优等方面花费大量精力。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>量化家</author>
<guid isPermaLink="false">2018-07-24-40449368</guid>
<pubDate>Tue, 24 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>【中信证券】量化实习生招聘（2019应届生）</title>
<link>https://henix.github.io/feeds/zhuanlan.c_106548378/2018-07-24-40441698.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/40441698&quot;&gt;原文&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;中信证券招聘量化实习生，优异者可留用（2019年校园招聘）。&lt;/p&gt;&lt;p&gt;实习招聘部门：中信证券股权衍生品业务线&lt;/p&gt;&lt;p&gt;股权衍生品业务线是中信证券开展权益类产品交易的业务部门，其业务模式是依托中信证券的信用和资产负债表，作为产品设计者和交易对手方，面向机构和零售客户提供种类丰富的与权益资产相关的投融资产品，满足客户各项需求。 &lt;/p&gt;&lt;p&gt;工作地：北京 亮马桥 中信证券总部。 &lt;/p&gt;&lt;p&gt;有意者请将简历寄送至EQ_HR@citics.com，2018年8月15日之前有效。 &lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;职责： &lt;/p&gt;&lt;p&gt;1、负责数据整理、挖掘、统计分析、展示； &lt;/p&gt;&lt;p&gt;2、从数据中发现规律，为量化分析提供支持； &lt;/p&gt;&lt;p&gt;3、开发量化模型策略； &lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;要求：&lt;/p&gt;&lt;p&gt;1、2019年毕业的硕士、博士。&lt;/p&gt;&lt;p&gt;2、知名院校的数学/统计、物理、计算机、电子或其他相关理工科专业； &lt;/p&gt;&lt;p&gt;3、一流的概率统计能力，严谨的研究习惯； &lt;/p&gt;&lt;p&gt;4、有一定的编程能力，至少熟悉Python和C++其中一门编程语言； &lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;加分项： &lt;/p&gt;&lt;p&gt;1、顶级的研究能力，有领先的学术成果； &lt;/p&gt;&lt;p&gt;2、学科竞赛、ACM-ICPC获奖； &lt;/p&gt;&lt;p&gt;3、熟悉深度学习原理和基本模型，熟练使用 Tensorflow，并能够灵活的解决实际问题。有过大型机器学习、数据挖掘实践项目者优先； &lt;/p&gt;&lt;p&gt;4、爬虫以及文本处理项目经历； &lt;/p&gt;&lt;p&gt;5、熟悉linux系统的非桌面环境, 良好的编码风格； &lt;/p&gt;</description>
<author>zhiqiang</author>
<guid isPermaLink="false">2018-07-24-40441698</guid>
<pubDate>Tue, 24 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>策略||缠论</title>
<link>https://henix.github.io/feeds/zhuanlan.c_106548378/2018-07-23-40365211.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/40365211&quot;&gt;原文&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;b&gt;一． 缠论理论体系梳理及精髓解读&lt;/b&gt;&lt;br&gt;&lt;b&gt;1.1 K线包含处理目的：清洗K线数据，识别顶底分型&lt;/b&gt;&lt;br&gt;相邻两K线可能出现包含关系（ 注： K线包含影线，且不分阴阳线）&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-77a4e20aa1f3f37b5445dfdd3c659b22_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;252&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-77a4e20aa1f3f37b5445dfdd3c659b22&quot; data-watermark-src=&quot;v2-3c9ce02a9f838d4c5d0d2944527f3b58&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-acecc35dcab111429f574b6939731977_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;448&quot; data-rawheight=&quot;255&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-acecc35dcab111429f574b6939731977&quot; data-watermark-src=&quot;v2-373053262ff437d6b247fadafb0b48d1&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;b&gt;1.2 分型：对局部高低点的识别（ K线已经过包含处理）&lt;/b&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-2ec90effb7ea2a6cccfe42e202e86f8a_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;255&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-2ec90effb7ea2a6cccfe42e202e86f8a&quot; data-watermark-src=&quot;v2-f6d6f773ebdf6195cb77a64b82e208e3&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;b&gt;1.3 笔：对阶段性高低点的识别（ K线已经过包含处理）&lt;/b&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-531677a7cc6175114502dc9e0d2db4d6_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;148&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-531677a7cc6175114502dc9e0d2db4d6&quot; data-watermark-src=&quot;v2-9899fe874d70723ca4f7a35f404dfe26&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;两个相邻的顶和底，并且顶分型和底分型之间至少有一根独立的K线，这就构成一笔，笔从其构成的K线走向看分为向上笔和向下笔。&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-b179f3df18fbdac3b584476e6297a69e_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;212&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-b179f3df18fbdac3b584476e6297a69e&quot; data-watermark-src=&quot;v2-e76f65c6d34e3f83fc13f9e531502fdc&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;将K线图的分型按照一顶一低交替出现的方式进行笔的连接，遇到连续两&lt;br&gt;个分型是同类分型时，笔将延伸， 忽略前面出现的，连接后面出现的分型。&lt;/p&gt;&lt;p&gt;&lt;b&gt;1.4 线段：&lt;/b&gt;&lt;/p&gt;&lt;b&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-963e091df9696d9481533bda8f806d72_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;566&quot; data-rawheight=&quot;172&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-963e091df9696d9481533bda8f806d72&quot; data-watermark-src=&quot;v2-6362ee719e5532f3289c09f9ab2f4dc8&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;/b&gt;&lt;p&gt;连续的三笔之间若存在重叠部分，其起点和终点之间的连线为线段。&lt;br&gt;同样，线段依据走势分为向上线段和向下线段。&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-fc3977988f50bc0279019c85f0400487_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;176&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-fc3977988f50bc0279019c85f0400487&quot; data-watermark-src=&quot;v2-6eb17792d75aeba2a098d811f58a2d9a&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;线段产生以后，若不在相反方向产生新线段，那么这个线段在同方向上继续延伸，否则称为线段被线段破环。&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-d49d9647e71aa215004198f51a8a436c_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;147&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-d49d9647e71aa215004198f51a8a436c&quot; data-watermark-src=&quot;v2-5fdadae63f7a5a7290656036bac14539&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;•  向上线段用笔的序列表示成： S1X1S2X2…Sn。反向往下运动的笔序列X1X2…Xn称&lt;br&gt;  之为向上线段的特征序列， 同理 S1S2…Sn序列称为向下线段的特征序列。&lt;/p&gt;&lt;p&gt;•  特征序列两相邻元素之间没有重叠的区间，称为序列的缺口。&lt;br&gt;•  对于特征序列，将每一元素看成一K线，也存在所谓的包含关系，也可以对此进行K线&lt;br&gt;  合并处理。经过处理的特征序列，称为标准特征序列。&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-befe74e7113d2c83bf82c6e8432e4d77_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;172&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-befe74e7113d2c83bf82c6e8432e4d77&quot; data-watermark-src=&quot;v2-94f865afaab650085cc877ca5ea6c010&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;准特征序列分型中，第一二元素无缺口&lt;br&gt;• 向上线段出现顶分型，线段结束于该顶分型的顶&lt;br&gt;• 向下线段出现底分型，线段结束于该底分型的底&lt;br&gt;&lt;/p&gt;&lt;p&gt;标准特征序列分型中，第一二元素存在缺口&lt;br&gt;• 向上线段出现顶分型，如果从该分型最高点开始的向下一笔开始的序列的特征序列出现底      分型，并且在完成底分型前不破顶分型最高点，那么该线段在该顶分型的高点处结束&lt;br&gt;• 向下线段同理&lt;/p&gt;&lt;p&gt;&lt;b&gt;1.5 中枢&lt;/b&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-8dc78093dfda14be87ec0cc124d6ce5c_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;553&quot; data-rawheight=&quot;134&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-8dc78093dfda14be87ec0cc124d6ce5c&quot; data-watermark-src=&quot;v2-e00783fac3aed0f327361bea2038034a&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;•  某级别走势类型中，被至少三个连续次级别走势类型所重叠的部分称为&lt;b&gt;中枢&lt;/b&gt;。向上走势 考察下上下…的次级别，向下走势考察下上下…的次级别。&lt;br&gt;•  对上升的线段，取其回撤构成中枢，对下降的线段，取其回升构成中枢。&lt;br&gt;•  中枢三种生长方式： 新生（前后两个中枢波动区间无重合）， 延伸（前后两个中枢中枢 区间重合），扩展（前后两个中枢中枢区间无重合，波动区间有重合）。&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-7ad414ff98321bbf3d6fd6934a61a341_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;558&quot; data-rawheight=&quot;151&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-7ad414ff98321bbf3d6fd6934a61a341&quot; data-watermark-src=&quot;v2-9e27310c196afde637c39d661ff2aba1&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;根据中枢的相对位置关系和数量，可将走势类型分为两类：&lt;br&gt;•  一个已完成的走势类型若只包含一个中枢，称其为盘整。&lt;br&gt;•  一个已完成的走势类型若包含两个以上的同向中枢，称其为趋势。中枢依次向上且波&lt;br&gt;动区间无重合，为上涨趋势；中枢依次向下且波动区间无重合，为下降趋势。&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-2c0c3c2a526aeb33898f9818ea5eb183_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;160&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-2c0c3c2a526aeb33898f9818ea5eb183&quot; data-watermark-src=&quot;v2-95c3d59ba1030d8bef2fcaa4b835f174&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;背驰：是指围绕同一中枢的前后两个次级别波动，后面的力度弱于前面。力度有多种衡量方式，缠论中用MACD， MACD又有三种标准（红绿柱子面积/红绿柱子高度/黄白线高度）。&lt;br&gt;&lt;/p&gt;&lt;p&gt;趋势背驰：趋势的最后一个中枢前后两个次级别波动，必须创新高/新低。例如， b段对应&lt;br&gt;的MACD柱子面积（向上看红柱子，向下看绿柱子）比a段对应的面积小,且b段创新高，这&lt;br&gt;就构成标准的趋势背驰。&lt;br&gt;&lt;/p&gt;&lt;p&gt;盘整背驰：与趋势背驰类似，但定义相对宽松。 通常比较的是同向的相邻两个次级别波动，并且不需要考虑是否创新高/低。&lt;/p&gt;&lt;p&gt;&lt;b&gt;1.7 三类买卖点&lt;/b&gt;&lt;/p&gt;&lt;b&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-f9f98a85b0c2234ced68d6c5ffe438af_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;197&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-f9f98a85b0c2234ced68d6c5ffe438af&quot; data-watermark-src=&quot;v2-972c09a34d91eac3266a7bfa56606722&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;/b&gt;&lt;p&gt;•  第一类买卖点由趋势背驰产生，第一类买卖点出现意味着原走势终结。&lt;br&gt;•  第二类买卖点出现在第一类买卖点之后，如果走势不创新低新高或者新低新高之后盘整背驰，都构成第二类买卖点。&lt;br&gt;•  第三类买卖点出现在最近的一个同级别中枢之上/之下，如果次级别离开后次级别回抽，回不到最近的一个同级别中枢中，则构成第三类买卖点，意味着中枢的新生或者中枢级别的扩展。&lt;/p&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>量化家</author>
<guid isPermaLink="false">2018-07-23-40365211</guid>
<pubDate>Mon, 23 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>策略||文字数据</title>
<link>https://henix.github.io/feeds/zhuanlan.c_106548378/2018-07-20-40184624.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/40184624&quot;&gt;原文&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;b&gt;   一直以来策略用到的即时文字数据，获取和处理都比较麻烦，这里笔者简单介绍一下获取和处理方法，关于文字数据因子的使用放到下一章节&lt;/b&gt;&lt;/p&gt;&lt;p&gt;1&lt;b&gt;数据的获取&lt;/b&gt;&lt;/p&gt;&lt;p&gt;依旧以对证券市场分析为例，常用到的数据有“财经新闻、上市公司公告、股吧网友讨论等”。我们希望从这些数据源中能得到有价值的信息，可能是一段时间的新闻热点、可能是网友对不同事件的正负面情绪、或者其他一些。&lt;br&gt;&lt;br&gt;第一步就是获取数据，新闻相关的有新浪财经、华尔街见闻等；上市公司公告有巨潮资讯网、交易所官网；股吧有东方财富网、雪球等。&lt;br&gt;&lt;br&gt;&lt;br&gt;一般选用的方法就是爬虫了，根据各网站的不同，爬取难易程度不一 。大规模爬虫可以选用：scrapy  分布式爬取，而一般简单的爬虫可以用： lxml、BeautifulSoup、 Requests、Selenium等。具体操作过程中，有些网站有比较强的反爬虫机制，需要加ip代理池等操作。&lt;br&gt; &lt;br&gt;&lt;b&gt;举个简单例子 —— 爬取中国证券报网站上近一周的所有公司新闻。&lt;/b&gt;&lt;br&gt;简单过程就是：&lt;br&gt;a. 找到目标网页的URL。&lt;br&gt;b. 在目标页面URL中找到目标内容并保存。&lt;br&gt;一般可以通过lxml.etree用xpath定位实现、或者用BeautifulSoup根据CSS定位实现。&lt;br&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-1d658dea70008150395d29266a3e2165_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;546&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-1d658dea70008150395d29266a3e2165&quot; data-watermark-src=&quot;v2-86cb9e775c20923511b3af6b6a5e2cc6&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-776a5e334ca5b7e7a8045fc4f042f6ae_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;605&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-776a5e334ca5b7e7a8045fc4f042f6ae&quot; data-watermark-src=&quot;v2-5fbecc75e54aea4ad620e4f6084a13ea&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;br&gt;至于数据的储存，各种数据库就依个人喜好了，例子中直接保存到txt里了。多说一句，例子中取的数据不牵涉到动态加载内容，如有需要最简单是selenium模拟，另外方法是Chrome F12 network，分析Ajax内容，构造请求。具体今天就先略去了。&lt;br&gt;&lt;/p&gt;&lt;p&gt;2&lt;b&gt;文本初步处理&lt;/b&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-a994af8d7f9d07b77f54a2e7c8a5d760_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;445&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-a994af8d7f9d07b77f54a2e7c8a5d760&quot; data-watermark-src=&quot;v2-5274c1e955905cdb9b53501b66d51e30&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;br&gt;取得数据之后下一步就是简单的处理了，对中文来说，就是分词，去停用词这些，可用的工具有： Jieba 、PyNlpir等。具体选哪个还是去试一下看哪个合适，自己选吧。&lt;br&gt;&lt;br&gt;&lt;br&gt;对于要让程序到practical的程度，分词还是很重要的，因为很多专业术语，所以自定义字典userdict比较重要。上面提到的两个包都可以导入自定义字典，要达到令人满意的结果，这userdict就看个人了。去停用词就是删除一些没什么实际意义的形容词、助词等。&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;b&gt;分词程序：&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-6d60a082b20dd98c28966fd42e30dea6_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;662&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-6d60a082b20dd98c28966fd42e30dea6&quot; data-watermark-src=&quot;v2-73ea147cc1d37a984818faa73138eed3&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;br&gt;&lt;b&gt;分词结果：&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;&lt;b&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-444ba97f68375ba86484d0dbbf83ee82_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;393&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-444ba97f68375ba86484d0dbbf83ee82&quot; data-watermark-src=&quot;v2-85793a8327f3749d4b7bb8ba021afda7&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;/b&gt;&lt;p&gt;3&lt;b&gt;提取关键词&lt;/b&gt;&lt;br&gt;下一步是把每个文本提取关键词，用关键词向量代表每个文本。&lt;br&gt;一般用的方法是有TF－IDF，具体细节可以wiki一下。很简单，主要意思就是一个词在文档中出现频率越高，对文档而言更重要； 同时一个词要是在所有文档中都出现，比如“的”，那就重要性减弱。于是抽象出 &quot;TF : termfrequency&quot; 和  &quot;IDF: inverse documentary frequency&quot;。以“国企改革”为例，“TF”算的是“国企改革”在文章中出现的频率，“IDF”算“国企改革”在所有文档中出现频率。&lt;br&gt;&lt;/p&gt;&lt;p&gt;一般采用log(...) * log(...)的形式，不过这个也可以变，没有一个规定。&lt;br&gt;scikit-learn中有直接封装好的TF-IDF程序，在这里我贴出一个自己写的：&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;关键词提取程序：&lt;/b&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-c016872bd77dd93252d4c91108168646_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;425&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-c016872bd77dd93252d4c91108168646&quot; data-watermark-src=&quot;v2-416d3e45fc7ca2852d640bdb187192e0&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;br&gt;&lt;b&gt;关键词提取结果：&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;&lt;b&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-08ee558afad11ec2b699764df6e3e808_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;640&quot; data-rawheight=&quot;400&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-08ee558afad11ec2b699764df6e3e808&quot; data-watermark-src=&quot;v2-424aafdfda9a32b39ff108566caa64c0&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;/b&gt;&lt;p&gt;&lt;br&gt;&lt;br&gt;这样处理之后，一片文章就可以用几十个关键词表示，再进行下一步的聚类分析等。&lt;br&gt;&lt;br&gt;常用的文本相关性分析方法有：求文档间的余弦Cosine、KMeans等。&lt;/p&gt;</description>
<author>量化家</author>
<guid isPermaLink="false">2018-07-20-40184624</guid>
<pubDate>Fri, 20 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>策略||遗传算法</title>
<link>https://henix.github.io/feeds/zhuanlan.c_106548378/2018-07-19-40082674.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/40082674&quot;&gt;原文&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;通常所说的量化交易，是指使用大量的指标和操作的组合，来定义买/卖操作规则。除了决定使用哪些指标，更重要的是为指标设置正确的参数。&lt;/p&gt;&lt;p&gt;一个简化的例子（&lt;b&gt;随机写的，请勿作为投资参考&lt;/b&gt;）：选择 300成份股 + 市值小于150亿 + 去年分红 + 最近半年有回购行为 的股票。我们可以把不同指标扩展到成千上万个，根据参数做出投资决策。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;为参数寻找最优解的问题，梯度下降法（常用于深度学习）是一个很好的解决方案。但有些时候1、问题有多个局部最优解；2、错误函数不平滑；这时梯度下降算法就不能很好工作。这里我们介绍遗传算法，用来为市场指标的参数找到最优解。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;遗传算法是受物种进化和自然选择启发得到的优化方法。它是一个“古老”的算法，并且在上个世纪就有人尝试应用于金融市场研究。严格来说它不属于机器学习领域，但机器学习工程实际上可以在它的理论基础上来实现。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;遗传算法过程如下:&lt;/p&gt;&lt;p&gt;&lt;b&gt;- 初始化：&lt;/b&gt;算法从初始化一个种群开始，可以完全随机生成。每种可能的解决方案 -- 例如每个种群中的个体—被称为染色体。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;- 迭代过程：&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;*  交叉：&lt;/b&gt;染色体被组合起来，产生一个新的种群。新一代种群中的每一条染色体都是它们祖先的基因（染色体由基因组成）交叉混合组成。&lt;/p&gt;&lt;p&gt;&lt;b&gt;*  突变：&lt;/b&gt;通常，还引入突变因子，目的是允许现有基因的特征有一些变化。&lt;/p&gt;&lt;p&gt;&lt;b&gt;*  评估：&lt;/b&gt;计算每个新染色体个体的适应值。&lt;/p&gt;&lt;p&gt;交叉迭代过程的理念是创建一个优于第一代种群的后代，因为只有&lt;b&gt;最合格的个体才能存活下来&lt;/b&gt;。 这意味着我们将选择得到最佳结果的染色体作为下一代染色体的父染色体。&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-1992c9e52486da53afed9fc9b01d2901_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;356&quot; data-rawheight=&quot;325&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-1992c9e52486da53afed9fc9b01d2901&quot; data-watermark-src=&quot;v2-c009722f801e96dd4f5c6cacbc823612&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;-  停止条件：&lt;/b&gt;我们可以使用两三种不同的标准作为停止迭代过程的条件：&lt;/p&gt;&lt;p&gt;   *  群众中个体数量不再变化；&lt;/p&gt;&lt;p&gt;   *  获得满意的适应性水平。&lt;/p&gt;&lt;p&gt;   *  算法得到收敛。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;我个人特别喜欢第一和第三个标准（除非时间极为有限，我会使用第二个标准)。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;实现遗传算法实际上是一项简单的任务。最具挑战的部分是如何将我们的问题转化为“染色体”模型。 我们需要可以轻松转换、组合的变量，以及无需大量的内存的算法，那么遗传算法就会有效。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;伪算法代码&lt;/b&gt;&lt;/p&gt;&lt;p&gt;以下代码是使用Python语法的遗传算法实施的简单示例，其中：&lt;/p&gt;&lt;p&gt;max_iter：是算法停止前允许的最大迭代次数。&lt;/p&gt;&lt;p&gt;n_repeats：是允许所有过程中的最佳适应度比通常总体达到的最佳适应度差的最大迭代次数。 这是用来控制方法的收敛程度的简单方法: 如果我们不使用这种方法，当算法已经停在局部最优时，我们还在花时间执行代码。&lt;/p&gt;&lt;p&gt;N：是在每次迭代中被选择成为下一代父染色体的个体数量。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;i=0 &lt;/p&gt;&lt;p&gt;fitness = 0 &lt;/p&gt;&lt;p&gt;counter = 0 &lt;/p&gt;&lt;p&gt;while i &amp;lt; max_iter: &lt;/p&gt;&lt;p&gt;   if counter &amp;gt; n_repeats: &lt;/p&gt;&lt;p&gt;      STOP &lt;/p&gt;&lt;p&gt;   Y = [ ]&lt;/p&gt;&lt;p&gt;   fit = [ ] &lt;/p&gt;&lt;p&gt;   pairs = randompairsfrom (X) &lt;/p&gt;&lt;p&gt;   for j in pairs: &lt;/p&gt;&lt;p&gt;      y = crossover ( j )&lt;/p&gt;&lt;p&gt;      y = randommutation ( y )&lt;/p&gt;&lt;p&gt;      Y. append (y)&lt;/p&gt;&lt;p&gt;      fit.append (fitness(y))&lt;/p&gt;&lt;p&gt;   Y, fit = ordermaxtomin (Y, fit ) &lt;/p&gt;&lt;p&gt;   bestfitness = fit[ 0 ]&lt;/p&gt;&lt;p&gt;   if bestfitness &amp;lt; fitness: &lt;/p&gt;&lt;p&gt;      counter = counter+1&lt;/p&gt;&lt;p&gt;   else: &lt;/p&gt;&lt;p&gt;      counter = 0&lt;/p&gt;&lt;p&gt;      X = Y [0: N] &lt;/p&gt;&lt;p&gt;      i=i+1 &lt;/p&gt;&lt;p&gt;      fitness = bestfitness&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;改进&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;另外一点需要重点考虑到，如上所述，由于遗传算法是一种优化方法，因此很容易得到问题的局部最优值。当发生这种情况时，很难进一步发展并且找到问题的另一最优值 。 为了强制算法“跳出”局部最优，我们可以做的一件事是改变“选择过程”。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;当算法“正常工作”时，我们从由上一代和新一代形成的组合中选择更好的基因。 如果我们发现算法“结果不理想” – 产生了一些迭代之后，最好的适应度没有变得更好 -- 我们就要做一个“强行跳跃”，具体做法是对最后的那一代基因不进行最优选择，然后继续迭代。当然，这样做，当前最优适应度会比上一代差，但是通过改变父亲一代，能让我们跳出当前局部最优，从而找到一套不同的解决方案（我们希望比其他的更好）。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;应用&lt;/b&gt;&lt;/p&gt;&lt;p&gt;现在你已经知道遗传算法的基本思路了。&lt;/p&gt;&lt;p&gt;下一步是决定如何将市场指标的参数的映射为对应的染色体。如果我们决定使用一种通用的方法来做转换，那就意味着我们能使用相同的遗传算法来优化多个不同的指标参数。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;还是文章开头的极简例子，如果我们对多个指标进行0、1编码，1表示选中，0表示剔除。那么指标模型就是类似 01110001110001111001 这样的“基因”字符串。通过遗传算法得到的历史数据适应性最佳字符串，就是我们想要的策略了。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;思考1：&lt;/p&gt;&lt;p&gt;使用遗传算法寻找到市场指标（在时间序列上）的最优参数，有什么好处，又有什么缺点？&lt;/p&gt;&lt;p&gt;遗传算法的优点是不用花太多的时间找到交易模型的有益参数。缺点也很清楚：使用优化方法的最大风险是过度拟合。算法只能拟合历史数据，在未来的博弈中未必有效。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;继续思考2：如果我们设计一种算法机制，能够检测出当前交易模型的参数不再有良好回报，然后再找到适合当前市场约束条件其它算法，会如何？&lt;/p&gt;</description>
<author>量化家</author>
<guid isPermaLink="false">2018-07-19-40082674</guid>
<pubDate>Thu, 19 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>仓位控制||启发</title>
<link>https://henix.github.io/feeds/zhuanlan.c_106548378/2018-07-18-40038927.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/40038927&quot;&gt;原文&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;资金管理是投资体系中非常重要的部分，却是大多数投资者忽略的环节，至少在我认识的投资朋友中，很少看到注重资金管理的，也很少讨论资金管理问题，很多朋友喜欢总是满仓的，喜欢全部资金或大部分资金重仓一只或两只股票；要么就空仓，资金撤离。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;国内一些知名的价值投资者，也几乎总是处于满仓状态。在熊市中，资金管理不好的问题会逐步暴露出来，让投资者陷入困境或被动之中。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;主要表现：过早加仓并用完资金，当持有的证券出现低得更多的价格时，已经没有能力买入补仓；满仓的一只或两只证券出现大幅向下波动后，带来巨额的账面浮亏，给投资者带来巨大的心理压力，并在压力下做出非理性的投资操作等等。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;我所说的资金管理主要指&lt;b&gt;现金管理和仓位管理。&lt;/b&gt;现金管理指投资者在所管理的投资资产对现金占比的考虑及安排，这里的现金既指货币现金，也指现金等价物，如短期国债等。仓位管理主要指对单只证券或同类证券在投资组合中的控制比例及额度管理等。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;投资者到底该如何进行资金管理，从而在各种环境下都能应对自如呢？我们看看几位着名的价值投资大师是如何做进行资金管理的。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;格雷厄姆&lt;/b&gt;——价值投资的鼻祖，巴菲特最尊敬的恩师，《证券分析》、《聪明投资者》的作者。格雷厄姆很早就开始进行投资，为客户管理资金，但在1929年大危机中，损失惨重，几乎破产。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;在经历过九死一生的大危机后，格雷厄姆在资金管理方面提出了「&lt;b&gt;75—25」法则&lt;/b&gt;，即：持有普通股的资金比例控制在25%至75%的范围，现金及债券则控制在75%至25%的互补区间之中，当股票资产因占比超过75%时，卖出一定数量的股票，增加现金或债券比例，当因股票资产占比到低于25%时，则卖出一定的债权增加股票的比例。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;当然，股票资产与债券（现金）的比例并不是完全铁定的75%至25%，投资者可以根据市场的高估或低估情况以及投资自身的特点设定一个合适的比例，如50%至50%等。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;格雷厄姆说，这样的做法有两个好处：克服人性的弱点；让投资者总是有点事情可做，不至于太单调。同时，格雷厄姆的投资组合非常分散，持有很多数量的证券，单只证券的占比很小。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;巴菲特&lt;/b&gt;——价值投资集大成者，在54年的投资生涯，累计获利62021.72倍，年复合收益率22.67%。巴菲特投资业绩还表现出了极高的稳定性，在54年的漫长投资生涯中，只有两个年份出现小幅亏损（2001年的-6.2%和2008年的-9.6%），这是业绩的稳定性是众多职业投资者梦寐以求的。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;巴菲特在1956年至1969年管理合伙投资期间，13年里没有发生一次亏损，累计获利28.88倍，年复合收益率29.5%。在此期间，巴菲特将投资机会类型分为低估类投资、控制类投资、套利类投资三类，并将资金分散投资于这些不同的投资机会上，巴菲特单只股票投资比例最大的股票是美国运通，从1964年开始陆续投入了1300万美元，占到所管理的合伙资产的40%左右。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;在巴菲特后期的投资生涯中，投资比例最大的是可口可乐，先后陆续投资了10.24亿美元，占到当时伯克希尔34亿美元净资产的30%左右。巴菲特认为：控制不好的「集中投资」有点类似于再乱流中行驶的飞机，它比地下的火车快，可上下左右摇晃的幅度太大，让人受不了，尽管最后安全着陆。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;在现金管理方面，巴菲特喜欢总是保留一定数额的现金，在近10年以来，巴菲特总是保持至少200亿美元的现金，截止2011年6月30日，伯克希尔持有的现金是478.9亿美元。在2008年美国金融危机期间投资了通用电气和高盛后，巴菲特减持了部分股票，他减持的理由是：现金偏少，让他觉得不踏实。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;他对于保持大量现金的理由是：不希望命运掌握他人手中，而是掌握在自己的手中，大量的现金可以让人睡得踏实等。事实上，正是由于总是喜欢持有一定的现金，巴菲特才可以安然度过多次经济危机及金融危机，并能够在危机中优秀公司出现非常低估的价格时，还有能力买入，而大部分投资者此时已经失去买卡入能力。巴菲特在资金管理方面堪称完美，是最值得借鉴、学习的投资大师。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;卡拉曼&lt;/b&gt;——Baupost基金公司总裁，最受投资者尊敬的价值投资大师之一，他的代表作《安全边际》（Margin of Safety）已成为重要的投资经典着作。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;卡拉曼管理的基金从1982 年到2009年的27年间年均收益率为19%，而同期的标准普尔500指数收益率仅为10.7%，更为难得的是，这25年里仅有一年亏损记录。卡拉曼投资管理的一大特点就是喜欢持有大量的现金。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;他在《晚上睡得着比什么都重要》的演讲说到：在过去的25年中，我们试图每天为客户做正确的事情，从不使用融资杠杆，且有时会持有大量现金，他有时候会持有40%多的现金（如1999年4月30日投资组合现金比例为42.1%）。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;他认为：在任何时候都保持满仓投资简化了投资任务，投资者似乎只要找到的最好的投资就可以了。相对诱人成了唯一的投资准绳，而无需满足绝对的价值标准。此类投资顶多只会带来普通的回报，最糟糕的情就是会产生高昂的机会成本——指错过了下一个出色的投资机会——并承受了出现巨大损失的风险。同时，卡拉曼的投资组合比较分散，单只证券投资比例不高。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;分析这三位价值投资大师的资金管理模式后，可以看到有两个共同特点：总是保留一定的现金；控制单只证券的投资比例，进行一定程度的分散。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;b&gt;「保留一定的现金」的内在逻辑：&lt;/b&gt;&lt;/blockquote&gt;&lt;p&gt;对市场保持敬畏，市场未来的发展是无法预测的，必须为可能出现的极端情况做一定准备；当没有非常具有吸引力的投资机会时，保留现金，宁缺毋滥；追求绝对回报，而不是相对表现；在意所管理资产表现的稳定性等。&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;b&gt;「进行一定的分散」的内在逻辑：&lt;/b&gt;&lt;/blockquote&gt;&lt;p&gt;投资判断可能出错，或者发生小概率事件，避免判断失误或发生的小概率事件带来致命的损失；考虑到其它机会成本；在意资产整体的稳定性等。&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;面三位价值投资的大师都是价值投资者的精神导师，他们资金管理模式给我们带来什么样的启示呢？&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;事实上，一个投资者的资金管理模式反映了他的投资哲学、世界观甚至性格。总是保留部分现金的投资者，他的投资哲学或性格可能是：认为对市场的未来持难以预测，对市场总是保持敬畏，担心会发生更为极端的情况，并为此对有所准备；追求绝对回报，坚持严格的投资标准，当没有满足符合条件的投资机会时，宁愿保留现金等；担心自己的判断有错误的可能，并为此留有余地等。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;而总是满仓的投资者：对自己的判断具有绝对的信心；希望资金总是处于高效使用状态；担心错过现在的投资机会；在意跑赢市场，而不是追求绝对回报等。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;只持有一只或两只股票的过度集中投资者，反映了他们：对自己的判断有绝对信心，总是认为有十足的把握；投资的证券是最好的等。而适当分散的投资者，则：担心自己判断可能出错；担心发生不利的小概率事件；希望保持资产组合表现一定的稳定性等。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;我自己经过多次惨痛的教训后，认识到了资金管理的重要性，一直在探索适合自己的资金管理的模式，经过多年的学习和实践之后，逐步形成了适合自己的资金管理模式。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;比如：总是喜欢保留至少10%的现金；单只证券的投资比例一般控制在20%以下，确定性特别高的投资机会则控制在40%以下；当确定投资目标后，喜欢分批建仓等。在这种资金管理模式下，我会觉得非常坦然，晚上睡觉也非常非常踏实。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;每个投资者可能因为自身投资哲学、性格等方面的不同，而选择不同的资金模式，只有这种模式是经过深思熟虑并适合自己的，都无可厚非。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;但对于专业投资者来说，特别是对于那些管理客户资金的职业投资者来说，格雷厄姆、巴菲特、卡拉曼三位投资大师的资金管理模式非常值得学习和借鉴，这种模式不仅带来了非常高的长期投资回报率，更为重要的是，业绩表现非常稳定。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;在不断惨烈下跌的熊市下，做好资金管理的重要性更加彰显。做好资金管理最大的障碍还是人性，特别是贪婪！&lt;/p&gt;&lt;p&gt;在量化上进行资金管理更为重要，因为一开始就设置好仓位逻辑，不进行人为的干预，才能更完全实现的策略的精准化。&lt;/p&gt;</description>
<author>量化家</author>
<guid isPermaLink="false">2018-07-18-40038927</guid>
<pubDate>Wed, 18 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>世界区块链大会&amp;YOYOW创始人白菜受邀参加圆桌座谈</title>
<link>https://henix.github.io/feeds/zhuanlan.c_106548378/2018-07-18-40002081.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/40002081&quot;&gt;原文&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-63b28b4f9bab05a187a134a492e306a2_r.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;乌镇开启区块链2018新征程&lt;/b&gt;&lt;br&gt;“世界区块链大会”于2018年6月28日至6月30日进行，会址位于乌镇的“互联网国际会展中心”（浙江省桐乡市乌镇西栅景区）。乌镇，是优雅而富庶的历史文化名城，更在2014年11月19日成为“世界互联网大会”的永久举办地，自此乌镇从安逸的江南水乡转变成了财富出发和技术进步的先锋起点。在蝉鸣悠远的夏天，主题为《2018看见未来》的“世界区块链大会” &lt;br&gt;拉开了帷幕。&lt;br&gt;&lt;/p&gt;&lt;p&gt;“世界区块链大会”于2018年6月28日至6月30日进行，会址位于乌镇的“互联网国际会展中心”。YOYOW项目创始人白菜受邀参与了此次圆桌会，并就行业关心的热点话题表达了自己的专业见解。&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-d41076bdfa674574bb199dbca32b2ca8_r.jpg&quot; data-caption=&quot;世界区块链大会圆桌座谈现场&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1080&quot; data-rawheight=&quot;720&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-d41076bdfa674574bb199dbca32b2ca8&quot; data-watermark-src=&quot;v2-53adf69b80b8e77b3eb8c08860bf1f83&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;行业先锋座谈共绘蓝图&lt;/b&gt;&lt;br&gt;这些区块链行业的资深从业者和长期爱好者来到这里，寻求加强海内外同行的交流碰撞，探讨和分享行业内共同面对的问题和挑战。并期待能够推进区块链技术和商业应用在中国更加健康、理性的发展。&lt;br&gt;在整个会议期间，有超过50+的知名嘉宾通过演讲分享实际案例，更有浙江电视台知名主持人小强主持的行业圆桌会，将区块链行业即将面对的机遇和挑战平摊在台面上，将会议气氛和实质探寻的深度推向了一个新的高度。&lt;br&gt;YOYOW项目创始人白菜受邀参与了此次圆桌会，并就行业关心的热点话题表达了自己的专业见解。YOYOW作为服务于内容领域的公链项目，旨在为类似知乎等UGC内容平台的内容创作者提供价值变现的服务。白菜本人从2013年起开始关注区块链技术，是行业成长的资深见证和参与者。&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-21ad66de912190826a3942ca8b5a0a30_r.jpg&quot; data-caption=&quot;YOYOW创始人白菜参与世界区块链大会圆桌座谈 &quot; data-size=&quot;normal&quot; data-rawwidth=&quot;600&quot; data-rawheight=&quot;400&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-21ad66de912190826a3942ca8b5a0a30&quot; data-watermark-src=&quot;v2-abffddfde7c59eaac023ccd2e20ad823&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;研究探讨 几个重要行业问题&lt;/b&gt;&lt;br&gt;在这场圆桌会上，来自浙江卫视的主持人小强提出了几个非常重要的问题供嘉宾作答。&lt;br&gt;在面对“有从业者将区块链技术分化为1.0、2.0甚至3.0的观点”时，白菜认为这种分化方式并不科学，他举例称曾经为大家所畅想的web3.0并没有发生，取而代之的是移动互联网时代，打车外卖等应用营运而生。他认为在区块链行业的基础建设完成之后，更多的发展应该是集中在行业应用上。&lt;br&gt;随后主持人提到“不可能的三角理论”：高效、去中心化、安全性几乎不可能同时出现在区块链应用上。面对这个尖锐的问题，各个嘉宾则都表现出足够的信心，均认为在具体应用上都可以得到有效的解决，如同互联网采用七层协议解决问题，区块链也并不需要在一个层面上解决所有的问题。&lt;br&gt;本次世界区块链大会的主题是：2018看见未来。在圆桌会的最后阶段，主持人询问在场嘉宾：在2018年百链齐发的状况下，各位来宾到底看见了怎样的未来，区块链会面对什么？这就像互联网在开始成长的过程中遇到的泡沫等问题一样，区块链也可能需要去面对这些。&lt;br&gt;白菜回应称：公链的开发是一项成本高、技术门槛高的事业，再加上技术成长是一件同步的事情，较早进入行业的项目优势会更加明显，在平台这个层面上的争夺恐怕年内就会结束，而面对互联网泡沫距离，BAT并不是当时的优胜者，他们只是活了下来，区块链的未来也依然会是个剩者为王的时代。&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-fed07687700e89f96bd00bc4f4461a43_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;600&quot; data-rawheight=&quot;400&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-fed07687700e89f96bd00bc4f4461a43&quot; data-watermark-src=&quot;v2-df4d35bad3f13514a19a29b55ebbfc51&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt; 消息来源：&lt;a href=&quot;https://mp.weixin.qq.com/s/i9KuoE2y9X3Tp7jMTU_Lhw&quot;&gt;YOYOW官方&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>瘦子</author>
<guid isPermaLink="false">2018-07-18-40002081</guid>
<pubDate>Wed, 18 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>策略||因子回溯</title>
<link>https://henix.github.io/feeds/zhuanlan.c_106548378/2018-07-17-39944861.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/39944861&quot;&gt;原文&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;b&gt;1. 目前的因子测试方法&lt;/b&gt;&lt;br&gt;目前的因子分析方法一般包括两方面：&lt;br&gt;1、 对因子收益率和 IC 的筛选：&lt;br&gt;◆     收益率：要求胜率或者 Top-Bottom 收益率超过设定值；&lt;br&gt;◆     IC：要求 IC 或者 T 检验超过设定值；&lt;br&gt;2、 对因子的单调性或者区分度的限制：&lt;br&gt;◆     单调性：要求因子收益率随因子的增加具有一定的单调性；&lt;br&gt;◆     区分度： 要求因子的不同分位数组合的收益率具有一定的差距；&lt;/p&gt;&lt;p&gt;&lt;b&gt;现有的因子筛选方法&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-96077b56eed8c6c9d9a056f1ce886b8f_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;333&quot; data-rawheight=&quot;232&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-96077b56eed8c6c9d9a056f1ce886b8f&quot; data-watermark-src=&quot;v2-a8724a6a0a5d7ae055aabcb2f4b5f39c&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;b&gt;如果只从上述角度考虑，对因子的分析就仅仅局限于静态分析：&lt;/b&gt;&lt;br&gt;(1) 没有考虑因子有效性的时间变化：因子的有效性具有时变性，随着持&lt;br&gt;有期的变化因子的有效性是不断变化的，不同因子的有效性呈现出不&lt;br&gt;同的衰变规律；&lt;br&gt;(2) 没有考虑环境或者风格板块对因子有效性的影响： 因子的有效性在不&lt;br&gt;同的股票池、不同的风格板块上可能具有不同的规律，不同的宏观环&lt;br&gt;境下因子可能具有不同的特征。&lt;/blockquote&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;b&gt;针对上述缺陷，我重新设计了测试的框架，着重增加了对因子有效性的动态&lt;/b&gt;&lt;br&gt;&lt;b&gt;分析：&lt;/b&gt;&lt;br&gt;(1) 增加了对因子时间变化特征的分析：&lt;br&gt;包括 IC 的分布、 IC 的衰变、自相关性的衰变、买入信号的保持或逆转等内容；&lt;br&gt;(2) 增加了对因子的情境特征分析：&lt;br&gt;包括不同股票池（指数成分股/行业/风格）上的因子选股分析，宏观指标与因&lt;br&gt;&lt;br&gt;子组合的分析，不同市场阶段上的因子表现等，目的是发现因子适应于什么样的股票群体，什么样的市场阶段和宏观环境。&lt;/blockquote&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;b&gt;其他考虑因素&lt;/b&gt;&lt;br&gt;(1) 改进了数据清洗方法， 增加了平均绝对偏差方法；&lt;br&gt;(2) 设定了标准化/分位数/组合权重/残余收益率四个层次，便于从不同角&lt;br&gt;度过滤特定风格对因子的影响，实现风格中性化，例如对于行业影响，&lt;br&gt;可以从因子的行业标准化、因子的行业分位、组合权重的行业中性和&lt;br&gt;从个股收益率中直接剔除行业收益率四个方面剔除因子中的行业影响；&lt;br&gt;(3) 增加了初步的风险控制方面的内容：如因子回测的历史变动、组合的&lt;br&gt;跟踪误差以及组合业绩的归因等；&lt;br&gt;(4) 考虑了幸存者偏差： 各种股票池的设定， 根据的都是历史成分股， 保&lt;br&gt;证了回溯测试的有效性；&lt;br&gt;(5)详细校订了因子的信息公布时间：保证了因子的实时性；&lt;br&gt;(6)对增长因子，采用趋势化的方法，避免采用算术增长率或者几&lt;br&gt;何增长率所造长的两点偏差；&lt;br&gt;(7) 建立了初步的因子库， 分为估值因子/成长因子/规模因子/动量因子/&lt;br&gt;财务质量因子/技术因子/预测因子六个部分。&lt;/blockquote&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;1. 数据输入&lt;/b&gt;&lt;br&gt;数据输入部分， 主要工作包括数据的采集和整理、数据结构的设计， 生成最终&lt;br&gt;因子分析所需的数据集。 测试所需的数据主要包括股票/指数/风格/宏观四个&lt;br&gt;方面， 对各类数据和因子， 我们进行了细致的处理和校对， 包括消除幸存者偏&lt;br&gt;差、前视偏差等等；&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;b&gt;2. 样本筛选&lt;/b&gt;&lt;br&gt;样本筛选部分， 主要功能是实现对股票池的初步筛选， 在因子测试时， 设定了三条筛选规则：&lt;br&gt;1) 剔除选股日的 ST/PT 股票；&lt;br&gt;2) 剔除上市不满一年的股票；&lt;br&gt;3) 剔除选股日由于停牌等原因而无法买入的股票；&lt;br&gt;当然，不同逻辑下可能会有不同的筛选，在这个测试框架下，允许添加对股&lt;/p&gt;&lt;p&gt;票池的其他筛选，但是所有筛选都要在样本筛选部分实现。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;b&gt;4. 数据清洗&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;数据清洗部分， 主要功能是完成对因子和收益率数据的清洗。 数据清洗的目的&lt;br&gt;是去掉可能的数据错误和极端数据， 保证最终得到的模型具有稳健性。&lt;br&gt;数据清洗的内容包括两部分，即异常值的处理和缺失值的处理。&lt;/p&gt;&lt;p&gt;(1) 异常值的处理：&lt;/p&gt;&lt;p&gt;对于异常值的定义， 用一种更为稳健的绝对中位偏差方法（ MAD）：&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-22093468ede00a5b3e7879f964ba828c_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;380&quot; data-rawheight=&quot;35&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;这里&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-bcd5e298a43dc0317d2906e13c49a566_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;38&quot; data-rawheight=&quot;30&quot; data-watermark=&quot;&quot; data-original-src=&quot;&quot; data-watermark-src=&quot;&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;是数据集。&lt;br&gt;实际上， 对于异常值的处理，不同的因子可能采用不同的方式， 可供选择的处&lt;br&gt;理方式包括定义为 NA 或者用相近值替代， 具体的处理方式取决于对异常值的&lt;br&gt;逻辑解释。&lt;br&gt;需要说明的是异常值只是一个相对概念，有许多不同的异常值定义方法，如对&lt;br&gt;单因子异常值通常的定义方法是利用方差、中位数和四分位数，具体剔除多少，选择哪种方法，取决于数据本身的特征和对数据的主观理解， 以及对敏感性和稳健型的平衡。&lt;br&gt;&lt;/p&gt;&lt;p&gt;(2) 缺省值的处理：&lt;br&gt;数据的缺失值有不同的来源，如有些是原始数据缺失，有些是异常值处理产生&lt;br&gt;的。对缺失值的处理方式要依据缺失值的来源和逻辑解释， 选取不同的操作，&lt;br&gt;包括剔除或者替代。&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;5.分析计算&lt;/b&gt;&lt;br&gt;分析计算部分， 主要功能是完成对因子特征的各种分析。 对不同的因子，依据&lt;br&gt;不同的逻辑，可以分不同层次设定因子分析的方式：&lt;br&gt;(1) 因子的标准化方法：&lt;br&gt;新版测试中可供选择的因子标准化方法包括四种，&lt;br&gt;(a)   普通标准化方法，即通常求 z 值的方法；&lt;br&gt;(b)   市值标准化方法， 相对于普通标准化方法，考虑了规模对均值的影响， 均&lt;br&gt;值为市值加权平均数；&lt;br&gt;(c)    随机数标准化，根据因子的样本分布随机生成一个样本，将随机生成的样&lt;br&gt;本值依次赋给对应股票作为标准化后的因子值，优点是可以将因子值转换&lt;br&gt;为服从特定分布的得分；&lt;br&gt;(d)    风格标准化，即将股票池划分为不同的风格， 将每个股票的因子值用所属&lt;br&gt;风格的风格平均值和风格标准差进行标准化，一个特例就是用不同行业的&lt;br&gt;行业均值和行业标准差进行因子的行业标准化。&lt;/p&gt;&lt;p&gt;&lt;br&gt;(2) 因子的分位数方法&lt;br&gt;可供选择的分位数方法有两种：&lt;br&gt;(a)    普通分位数方法，即在整个股票池进行分位数计算；&lt;br&gt;(b)    风格分位数方法， 即在每个风格上进行分位数计算，然后构成整体股票池&lt;br&gt;的分位数结果。&lt;/p&gt;&lt;p&gt;风格分位方法，能够保证在每个分位组上，从数目上看各个风格是均匀分布的。风格分位的一个特例就是行业分位，即分别在每个行业上进行分位数计算，从而保证各个分位组中的行业分布在数目上是均匀的。&lt;/p&gt;&lt;p&gt;&lt;br&gt;(3) 组合的权重方法&lt;br&gt;可供选择的组合权重方法有三种，&lt;br&gt;(a) 等权重方法，即组合中的每个股票具有同等的权重；&lt;br&gt;(b) 市值加权方法，即组合中的股票权重取决于股票的市值大小；&lt;br&gt;(c) 风格中性权重方法，即组合中的股票权重由股票的市值和股票所属风格在指数中所占的权重决定；&lt;/p&gt;&lt;p&gt;实际上，采用风格分位+市值加权，与采用普通分位+风格中性权重， 当指数权&lt;br&gt;&lt;/p&gt;&lt;p&gt;重与市值权重一致时，两种方法都能达到同样的风格中性效果。&lt;/p&gt;&lt;p&gt;&lt;br&gt;(4) 残余收益率方法&lt;br&gt;对风格影响的剔除，除了从上述标准化、分位数和权重三个角度考虑外，最后&lt;br&gt;一个方法就是直接从股票收益率中剔除所在风格板块的收益率。&lt;br&gt;下图说明了上述四种处理方式的关系，分位数、 标准化和残余收益率三种方法&lt;br&gt;是从影响 IC 角度影响因子的有效性，而权重是从收益率角度影响因子的有效&lt;br&gt;性。&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-907287182d341e74d135f34fc3ab4603_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;578&quot; data-rawheight=&quot;248&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-907287182d341e74d135f34fc3ab4603&quot; data-watermark-src=&quot;v2-458b4c3933f003dff0e33b502797c4f6&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>量化家</author>
<guid isPermaLink="false">2018-07-17-39944861</guid>
<pubDate>Tue, 17 Jul 2018 00:00:00 +0800</pubDate>
</item>
</channel>
</rss>
