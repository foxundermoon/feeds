<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>智能合约的形式验证</title>
</head>
<body>
<p><a href="http://www.yinwang.org/blog-cn/2019/02/22/smart-contract">原文</a></p>
<script>
            if (/mobile/i.test(navigator.userAgent) || /android/i.test(navigator.userAgent))
            {
               document.body.classList.add('mobile');
            }
        </script><div class="inner">
            <h2>智能合约的形式验证</h2>
            <p>在之前一篇<a href="http://www.yinwang.org/blog-cn/2017/04/23/ai">关于人工智能的文章</a>里，我指出了“自动编程”的不可能性。今天我想来谈谈一个相关的话题：智能合约的形式验证。有些人声称要实现基于“深度学习”的，自动的智能合约形式验证，然而今天我要告诉你的是，跟自动编程一样，完全自动的合约验证，也是不可能实现的。</p>

<p>随着区块链技术的愈演愈烈，很多人开始在以太坊的“智能合约语言”上做文章。其中一部分是搞 PL 的人，他们试图对 Solidity 之类语言写的智能合约进行形式验证（formal verification），号称要用严密的数理逻辑方法，自动的验证智能合约的正确性。</p>

<p>形式验证的其中一种办法是 <a href="https://en.wikipedia.org/wiki/Hoare_logic">Hoare Logic</a>。它的做法是，先给代码标注一些“前条件”和“后条件”（pre-condition 和 post-condition），然后就可以进行逻辑推理，验证代码的某些基本属性，比如转账函数之后余额是正确的。</p>

<p>举一个很简单的 Hoare Logic 例子：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{x=0}   x:=x+1   {x&gt;0}
</code></pre></div></div>

<p>它的意思是，如果开头 x 等于 0，那么 x:=x+1 执行之后，x 应该大于 0。这里的前条件（pre-condition）是“x 等于 0”，后条件（post-condition）是“x 大于 0”。如果 x 开头是零，执行 <code class="highlighter-rouge">x:=x+1</code> 之后，x 就等于 1，所以 x&gt;0 是成立的。所以这句代码就验证通过了。</p>

<p>Hoare Logic 的系统把所有这些前后条件和代码串接起来，经过逻辑推导验证，就可以作出这样的保证：在前条件满足的情况下，执行代码之后，后条件一定是成立的。如果所有这些条件都满足，系统就认为这是“正确的程序”。注意这里的所谓“正确”，完全是由人来决定的，系统并不知道“正确”是什么意思。</p>

<p>Hoare Logic 对于程序的安全性，确实可以起到一定的效果，它已经被应用到了一些实际的项目。比如微软 Windows 的驱动程序代码里面有一种标注语言，叫做 SAL，其实就是 Hoare Logic 的一个实现。然而前条件和后条件是什么，你必须自己给代码加上标注，否则系统就不能工作。</p>

<p>比如上面的例子，系统如何知道我想要“x&gt;0”这个性质呢？只有我自己把它写出来。所以要使用 Hoare Logic，必须在代码上标注很多的 pre-condtion 和 post-condition。这些条件要如何写，必须要深入理解程序语言和形式逻辑的原理。这个工作需要经过严格训练的专家来完成，而且需要很多的时间。</p>

<p>所以呢，有人就提出一个想法，他们要用“深度学习”的方法，通过对已有标注的代码进行机器学习，最后让机器自动标注这些前后条件。还在“空想”阶段呢，他们却已经把这种“自动标注”方法，作为自己的“优势”写进了白皮书：“我们的方法是自动的，其他的项目都是手动的……”</p>

<p>很可惜的是，“自动标注”其实跟“自动编程”是一样的空想。自动编程的难点在于机器没法知道你想要什么。同理，自动标注的难度在于，机器没法知道你想要代码满足什么样的性质（property）。</p>

<p>除非你告诉它，机器永远无法知道函数参数必须满足什么样的条件（前条件），它也无法知道函数出口应该满足什么样的条件（后条件）。比如上面的那个例子，机器怎么知道你想要程序执行之后 x 大于零呢？除非你告诉它，它是不可能知道的。</p>

<p>所以，利用深度学习自动标注 Hoare Logic 的前后条件，跟“自动编程”一样，是在试图实现“读心术”，那显然是不可能的。作为资深的 PL 和形式验证专家，这些人应该知道这是不可能自动实现的。他们提出这样的想法，并且把它作为相对于其他智能合约项目的优势，当然只是为了忽悠外行，为了发币圈钱 ;)</p>

<p>如果真能用深度学习生成前后条件，从而完全自动的验证程序的正确性，那么这种办法应该早就在形式验证领域炸锅了。每一个形式验证专家都希望能够完全自动的证明程序的正确性，然而他们早就知道那是不可能的。因为机器不知道人想要什么，它不知什么叫做“正确”，除非你告诉它！</p>

<p>设计语言来告诉机器我们想要什么，什么叫做“正确”，这本身就是 PL 专家和形式验证专家的工作。设计出了语言，我们还得依靠优秀的程序员来写这些代码，告诉机器我们想要做什么。我们得依靠优秀的安全专家，给代码加上前后条件标注，告诉机器什么叫做“正确的代码”…… 这一切都必须是人工完成的，无法靠机器自动完成。</p>

<p>说到这些，我就为这些学者感到悲哀，想不鄙视他们都不行了 :p 很早的时候我就有这种感觉，总是有些 PL 人看到什么方向有钱就往什么方向上靠，拿一堆吓人的术语来忽悠外行。管它一个外行设计的语言有多垃圾呢，我们帮它做形式验证工具，我们为它写编译器，写虚拟机，为它提出“形式化语义”（formal semantics）！给外行打下手，做一些毫无意义的工作，完全失去作为一个专家的责任感和尊严。</p>

<p>现在这种风气愈演愈烈，随着比特币和以太坊的热门，他们开始在 Solidity 之类的语言和智能合约上做文章。新瓶子装老酒，反反复复做同样的事情。甚至完全失去职业道德，号称要实现一些早就知道不可能的事情。</p>

<p>显然，我也可以轻而易举做出对智能合约进行某种“验证”或者“静态分析”的工具，然而我深刻的知道，数理逻辑对于程序正确性的局限。很多代码没法被证明为正确，但它们确实是正确的。很多代码有 bug，却没有任何工具可以发现它们。这是一个不幸的事实，就像无法实现永动机一样，没有任何人能够改变。</p>

<p>做这样的工作也许能圈到钱，然而却是非常枯燥而没有成就感的。为此我拒绝了好几个有关区块链的合作，因为他们想利用我这方面的才能，或者想利用我的名气。我对智能合约的正确性验证不感兴趣，虽然我对区块链的其它一些技术是感兴趣的。</p>

<p>当然，我并没有排除对智能合约手动加上标记这种做法的可行性，它是有一定价值的。我只是想提醒大家，这些标记必须是人工来写的，不可能自动产生。虽然工具可以有一定的辅助作用，但如果写代码的人自己不小心，是无法保证程序的完全正确的。</p>

<p>如何保证智能合约的正确呢？这跟保证程序的正确性是一样的问题。只有懂得如何写出干净简单的代码，非常严密的思考，才能写出正确的智能合约。关于如何写出干净，简单，严密可靠的代码，你可以参考我之前的一些文章。</p>

<p>这篇文章可能对于比特币，区块链方向的投资者有很大的价值。如果我拯救了你的投资，请考虑给我<a href="http://www.yinwang.org/blog-cn/2016/04/13/pay-blog">付费</a>支持。价格不贵，只要一个 BTC ;)</p>


        </div>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
</body>
</html>
